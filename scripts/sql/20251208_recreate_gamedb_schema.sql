-- Drop existing tables if they exist (Clean Slate)
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_COMPANIES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_COMPANIES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_THEMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_THEMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_MODES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_MODES_DEF CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_PERSPECTIVES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_PERSPECTIVES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_ENGINES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_ENGINES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_FRANCHISES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_FRANCHISES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_COLLECTIONS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_GENRES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GENRES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_RELEASES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_PLATFORMS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_REGIONS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- Create Region Definitions
CREATE TABLE GAMEDB_REGIONS (
    REGION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REGION_CODE VARCHAR2(10) NOT NULL UNIQUE,
    REGION_NAME VARCHAR2(100) NOT NULL,
    IGDB_REGION_ID NUMBER,
    CONSTRAINT UQ_GAMEDB_REGIONS_IGDB UNIQUE (IGDB_REGION_ID)
);

-- Create Platform Definitions
CREATE TABLE GAMEDB_PLATFORMS (
    PLATFORM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PLATFORM_CODE VARCHAR2(20) NOT NULL UNIQUE,
    PLATFORM_NAME VARCHAR2(100) NOT NULL,
    IGDB_PLATFORM_ID NUMBER,
    CONSTRAINT UQ_GAMEDB_PLATFORMS_IGDB UNIQUE (IGDB_PLATFORM_ID)
);

-- Create Games Table
CREATE TABLE GAMEDB_GAMES (
    GAME_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(255) NOT NULL UNIQUE,
    DESCRIPTION CLOB,
    IMAGE_DATA BLOB,
    IGDB_ID NUMBER,
    SLUG VARCHAR2(255),
    TOTAL_RATING NUMBER,
    IGDB_URL VARCHAR2(512),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT UQ_GAMEDB_GAMES_IGDB_ID UNIQUE (IGDB_ID)
);

CREATE OR REPLACE TRIGGER TRG_GAMEDB_GAMES_UPD
BEFORE UPDATE ON GAMEDB_GAMES
FOR EACH ROW
BEGIN
   :NEW.UPDATED_AT := CURRENT_TIMESTAMP;
END;
/

-- Create Game Releases Table
CREATE TABLE GAMEDB_RELEASES (
    RELEASE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    GAME_ID NUMBER NOT NULL,
    PLATFORM_ID NUMBER NOT NULL,
    REGION_ID NUMBER NOT NULL,
    FORMAT VARCHAR2(20) CHECK (FORMAT IN ('Physical', 'Digital')),
    RELEASE_DATE DATE,
    NOTES VARCHAR2(255),
    CONSTRAINT FK_GR_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
    CONSTRAINT FK_GR_PLATFORM FOREIGN KEY (PLATFORM_ID) REFERENCES GAMEDB_PLATFORMS(PLATFORM_ID),
    CONSTRAINT FK_GR_REGION FOREIGN KEY (REGION_ID) REFERENCES GAMEDB_REGIONS(REGION_ID)
);

CREATE INDEX IDX_GR_GAME ON GAMEDB_RELEASES(GAME_ID);
CREATE INDEX IDX_GR_PLATFORM ON GAMEDB_RELEASES(PLATFORM_ID);
CREATE INDEX IDX_GR_REGION ON GAMEDB_RELEASES(REGION_ID);

-- Create Genres Table
CREATE TABLE GAMEDB_GENRES (
    GENRE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    IGDB_GENRE_ID NUMBER UNIQUE
);

-- Create Game Genres Mapping Table (Many-to-Many)
CREATE TABLE GAMEDB_GAME_GENRES (
    GAME_ID NUMBER NOT NULL,
    GENRE_ID NUMBER NOT NULL,
    CONSTRAINT PK_GAME_GENRES PRIMARY KEY (GAME_ID, GENRE_ID),
    CONSTRAINT FK_GG_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
    CONSTRAINT FK_GG_GENRE FOREIGN KEY (GENRE_ID) REFERENCES GAMEDB_GENRES(GENRE_ID)
);

-- Seed Initial Regions (with IGDB IDs)
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('NA', 'North America', 2);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('EU', 'Europe', 1);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('JP', 'Japan', 5);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('WW', 'Worldwide', 8);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('AUS', 'Australia', 3);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('NZ', 'New Zealand', 4);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('CN', 'China', 6);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('AS', 'Asia', 7);

-- Seed Initial Platforms (with common IGDB IDs)
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('SWITCH', 'Nintendo Switch', 130);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PS5', 'PlayStation 5', 167);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PS4', 'PlayStation 4', 48);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PC', 'PC (Windows/Linux/Mac)', 6);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('XBOX', 'Xbox Series X|S', 169);
