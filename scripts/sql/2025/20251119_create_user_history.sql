-- History tables to track Discord user nickname and avatar changes.

CREATE TABLE RPG_CLUB_USER_NICK_HISTORY (
  EVENT_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID       VARCHAR2(30) NOT NULL, -- Discord snowflake
  OLD_NICK      VARCHAR2(100),
  NEW_NICK      VARCHAR2(100),
  CHANGED_AT    TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE INDEX IX_RPG_CLUB_USER_NICK_HISTORY_USER ON RPG_CLUB_USER_NICK_HISTORY (USER_ID, CHANGED_AT);

CREATE TABLE RPG_CLUB_USER_AVATAR_HISTORY (
  EVENT_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID       VARCHAR2(30) NOT NULL, -- Discord snowflake
  AVATAR_HASH   VARCHAR2(128),         -- Discord avatar hash (useful for dedupe)
  AVATAR_URL    VARCHAR2(512),         -- CDN URL at time of capture
  AVATAR_BLOB   BLOB,                  -- Raw avatar image (optional; may be NULL)
  CHANGED_AT    TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE INDEX IX_RPG_CLUB_USER_AVATAR_HISTORY_USER ON RPG_CLUB_USER_AVATAR_HISTORY (USER_ID, CHANGED_AT);

-- Trigger: log nickname/global name changes
CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_NICK_HIST
AFTER UPDATE OF USERNAME, GLOBAL_NAME ON RPG_CLUB_USERS
FOR EACH ROW
DECLARE
  l_old VARCHAR2(100);
  l_new VARCHAR2(100);
BEGIN
  l_old := NVL(:OLD.GLOBAL_NAME, :OLD.USERNAME);
  l_new := NVL(:NEW.GLOBAL_NAME, :NEW.USERNAME);

  IF NVL(l_old, '#NULL#') != NVL(l_new, '#NULL#') THEN
    INSERT INTO RPG_CLUB_USER_NICK_HISTORY (USER_ID, OLD_NICK, NEW_NICK, CHANGED_AT)
    VALUES (:NEW.USER_ID, l_old, l_new, SYSTIMESTAMP);
  END IF;
END;
/

-- Trigger: log avatar blob changes
CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_AVATAR_HIST
AFTER UPDATE ON RPG_CLUB_USERS
FOR EACH ROW
DECLARE
  l_diff INTEGER := 0;
BEGIN
  -- Only act when the avatar blob changed
  IF :OLD.AVATAR_BLOB IS NULL AND :NEW.AVATAR_BLOB IS NULL THEN
    RETURN;
  ELSIF :OLD.AVATAR_BLOB IS NULL OR :NEW.AVATAR_BLOB IS NULL THEN
    l_diff := 1;
  ELSE
    l_diff := DBMS_LOB.COMPARE(:OLD.AVATAR_BLOB, :NEW.AVATAR_BLOB);
  END IF;

  IF l_diff <> 0 THEN
    INSERT INTO RPG_CLUB_USER_AVATAR_HISTORY (USER_ID, AVATAR_HASH, AVATAR_URL, AVATAR_BLOB, CHANGED_AT)
    VALUES (:NEW.USER_ID, NULL, NULL, :NEW.AVATAR_BLOB, SYSTIMESTAMP);
  END IF;
END;
/
