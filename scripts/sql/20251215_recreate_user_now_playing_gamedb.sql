-- Recreate USER_NOW_PLAYING as GameDB-backed (no free text)

BEGIN
  EXECUTE IMMEDIATE 'DROP TABLE USER_NOW_PLAYING CASCADE CONSTRAINTS';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

CREATE TABLE USER_NOW_PLAYING (
  ENTRY_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID        VARCHAR2(30) NOT NULL,
  GAMEDB_GAME_ID NUMBER NOT NULL,
  ADDED_AT       TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE USER_NOW_PLAYING
  ADD CONSTRAINT FK_USER_NOW_PLAYING_GAMEDB
  FOREIGN KEY (GAMEDB_GAME_ID)
  REFERENCES GAMEDB_GAMES (GAME_ID);

ALTER TABLE USER_NOW_PLAYING
  ADD CONSTRAINT UQ_USER_NOW_PLAYING_GAMEDB
  UNIQUE (USER_ID, GAMEDB_GAME_ID);

CREATE INDEX IX_USER_NOW_PLAYING_USER ON USER_NOW_PLAYING (USER_ID);

COMMIT;
