CREATE TABLE RPG_CLUB_STEAM_COLLECTION_IMPORTS (
  IMPORT_ID           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID             VARCHAR2(30) NOT NULL,
  STATUS              VARCHAR2(20) NOT NULL,
  CURRENT_INDEX       NUMBER DEFAULT 0 NOT NULL,
  TOTAL_COUNT         NUMBER DEFAULT 0 NOT NULL,
  STEAM_ID64          VARCHAR2(20) NOT NULL,
  STEAM_PROFILE_REF   VARCHAR2(255),
  SOURCE_PROFILE_NAME VARCHAR2(255),
  CREATED_AT          TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT          TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE RPG_CLUB_STEAM_COLLECTION_IMPORTS
  ADD CONSTRAINT CK_STEAM_COLL_IMPORTS_STATUS
  CHECK (STATUS IN ('ACTIVE', 'PAUSED', 'COMPLETED', 'CANCELED'));

CREATE TABLE RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS (
  ITEM_ID                NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  IMPORT_ID              NUMBER NOT NULL,
  ROW_INDEX              NUMBER NOT NULL,
  STEAM_APP_ID           NUMBER NOT NULL,
  STEAM_APP_NAME         VARCHAR2(500) NOT NULL,
  PLAYTIME_FOREVER_MIN   NUMBER,
  PLAYTIME_WINDOWS_MIN   NUMBER,
  PLAYTIME_MAC_MIN       NUMBER,
  PLAYTIME_LINUX_MIN     NUMBER,
  PLAYTIME_DECK_MIN      NUMBER,
  LAST_PLAYED_AT         DATE,
  STATUS                 VARCHAR2(20) NOT NULL,
  MATCH_CONFIDENCE       VARCHAR2(20),
  MATCH_CANDIDATE_JSON   CLOB,
  GAMEDB_GAME_ID         NUMBER,
  COLLECTION_ENTRY_ID    NUMBER,
  RESULT_REASON          VARCHAR2(40),
  ERROR_TEXT             VARCHAR2(2000)
);

ALTER TABLE RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT FK_STEAM_COLL_IMPORT_ITEMS
  FOREIGN KEY (IMPORT_ID)
  REFERENCES RPG_CLUB_STEAM_COLLECTION_IMPORTS (IMPORT_ID);

ALTER TABLE RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT CK_STEAM_COLL_ITEMS_STATUS
  CHECK (STATUS IN ('PENDING', 'ADDED', 'UPDATED', 'SKIPPED', 'FAILED'));

ALTER TABLE RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT CK_STEAM_COLL_ITEMS_REASON
  CHECK (
    RESULT_REASON IS NULL OR
    RESULT_REASON IN (
      'AUTO_MATCH',
      'MANUAL_REMAP',
      'DUPLICATE',
      'MANUAL_SKIP',
      'SKIP_MAPPED',
      'NO_CANDIDATE',
      'INVALID_REMAP',
      'PLATFORM_UNRESOLVED',
      'ADD_FAILED'
    )
  );

CREATE TABLE RPG_CLUB_STEAM_APP_GAMEDB_MAP (
  MAP_ID          NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  STEAM_APP_ID    NUMBER NOT NULL,
  GAMEDB_GAME_ID  NUMBER,
  STATUS          VARCHAR2(20) NOT NULL,
  CREATED_BY      VARCHAR2(30),
  CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE RPG_CLUB_STEAM_APP_GAMEDB_MAP
  ADD CONSTRAINT UX_STEAM_APP_GAMEDB_MAP_APP
  UNIQUE (STEAM_APP_ID);

ALTER TABLE RPG_CLUB_STEAM_APP_GAMEDB_MAP
  ADD CONSTRAINT CK_STEAM_APP_GAMEDB_MAP_STATUS
  CHECK (STATUS IN ('MAPPED', 'SKIPPED'));

CREATE INDEX IX_STEAM_COLL_IMPORTS_USER
  ON RPG_CLUB_STEAM_COLLECTION_IMPORTS (USER_ID, STATUS);
CREATE INDEX IX_STEAM_COLL_ITEMS_IMPORT
  ON RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX);
CREATE INDEX IX_STEAM_COLL_ITEMS_APP
  ON RPG_CLUB_STEAM_COLLECTION_IMPORT_ITEMS (STEAM_APP_ID);
CREATE INDEX IX_STEAM_APP_GAMEDB_MAP_STATUS
  ON RPG_CLUB_STEAM_APP_GAMEDB_MAP (STATUS);

CREATE OR REPLACE TRIGGER TRG_STEAM_COLL_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_STEAM_COLLECTION_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_STEAM_APP_GAMEDB_MAP_UPD
BEFORE UPDATE ON RPG_CLUB_STEAM_APP_GAMEDB_MAP
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
