CREATE TABLE RPG_CLUB_GAMEDB_IMPORTS (
  IMPORT_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID         VARCHAR2(30) NOT NULL,
  STATUS          VARCHAR2(20) NOT NULL,
  CURRENT_INDEX   NUMBER DEFAULT 0 NOT NULL,
  TOTAL_COUNT     NUMBER DEFAULT 0 NOT NULL,
  SOURCE_FILENAME VARCHAR2(255),
  CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE TABLE RPG_CLUB_GAMEDB_IMPORT_ITEMS (
  ITEM_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  IMPORT_ID            NUMBER NOT NULL,
  ROW_INDEX            NUMBER NOT NULL,
  GAME_TITLE           VARCHAR2(500) NOT NULL,
  RAW_GAME_TITLE       VARCHAR2(500),
  PLATFORM_NAME        VARCHAR2(200),
  REGION_NAME          VARCHAR2(200),
  INITIAL_RELEASE_DATE DATE,
  STATUS               VARCHAR2(20) NOT NULL,
  GAMEDB_GAME_ID       NUMBER,
  ERROR_TEXT           VARCHAR2(2000)
);

ALTER TABLE RPG_CLUB_GAMEDB_IMPORT_ITEMS
  ADD CONSTRAINT FK_GAMEDB_IMPORT_ITEMS
  FOREIGN KEY (IMPORT_ID)
  REFERENCES RPG_CLUB_GAMEDB_IMPORTS (IMPORT_ID);

CREATE INDEX IX_GAMEDB_IMPORTS_USER ON RPG_CLUB_GAMEDB_IMPORTS (USER_ID, STATUS);
CREATE INDEX IX_GAMEDB_ITEMS_IMPORT ON RPG_CLUB_GAMEDB_IMPORT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX);

CREATE OR REPLACE TRIGGER TRG_GAMEDB_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_GAMEDB_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
