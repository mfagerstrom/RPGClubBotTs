CREATE TABLE RPG_CLUB_COLLECTION_CSV_IMPORTS (
  IMPORT_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID           VARCHAR2(30) NOT NULL,
  STATUS            VARCHAR2(20) NOT NULL,
  CURRENT_INDEX     NUMBER DEFAULT 0 NOT NULL,
  TOTAL_COUNT       NUMBER DEFAULT 0 NOT NULL,
  SOURCE_FILE_NAME  VARCHAR2(255),
  SOURCE_FILE_SIZE  NUMBER,
  TEMPLATE_VERSION  VARCHAR2(20),
  CREATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE RPG_CLUB_COLLECTION_CSV_IMPORTS
  ADD CONSTRAINT CK_COLL_CSV_IMPORTS_STATUS
  CHECK (STATUS IN ('ACTIVE', 'PAUSED', 'COMPLETED', 'CANCELED'));

CREATE TABLE RPG_CLUB_COLLECTION_CSV_IMPORT_ITEMS (
  ITEM_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  IMPORT_ID            NUMBER NOT NULL,
  ROW_INDEX            NUMBER NOT NULL,
  RAW_TITLE            VARCHAR2(500) NOT NULL,
  RAW_PLATFORM         VARCHAR2(200),
  RAW_OWNERSHIP_TYPE   VARCHAR2(60),
  RAW_NOTE             VARCHAR2(500),
  RAW_GAMEDB_ID         NUMBER,
  RAW_IGDB_ID           NUMBER,
  PLATFORM_ID          NUMBER,
  OWNERSHIP_TYPE       VARCHAR2(30),
  NOTE                 VARCHAR2(500),
  STATUS               VARCHAR2(20) NOT NULL,
  MATCH_CONFIDENCE     VARCHAR2(20),
  MATCH_CANDIDATE_JSON CLOB,
  GAMEDB_GAME_ID       NUMBER,
  COLLECTION_ENTRY_ID  NUMBER,
  RESULT_REASON        VARCHAR2(40),
  ERROR_TEXT           VARCHAR2(2000)
);

ALTER TABLE RPG_CLUB_COLLECTION_CSV_IMPORT_ITEMS
  ADD CONSTRAINT FK_COLL_CSV_IMPORT_ITEMS
  FOREIGN KEY (IMPORT_ID)
  REFERENCES RPG_CLUB_COLLECTION_CSV_IMPORTS (IMPORT_ID);

ALTER TABLE RPG_CLUB_COLLECTION_CSV_IMPORT_ITEMS
  ADD CONSTRAINT CK_COLL_CSV_ITEMS_STATUS
  CHECK (STATUS IN ('PENDING', 'ADDED', 'UPDATED', 'SKIPPED', 'FAILED'));

ALTER TABLE RPG_CLUB_COLLECTION_CSV_IMPORT_ITEMS
  ADD CONSTRAINT CK_COLL_CSV_ITEMS_REASON
  CHECK (
    RESULT_REASON IS NULL OR
    RESULT_REASON IN (
      'AUTO_MATCH',
      'CSV_GAMEDB_ID',
      'CSV_IGDB_ID',
      'MANUAL_REMAP',
      'DUPLICATE',
      'MANUAL_SKIP',
      'NO_CANDIDATE',
      'INVALID_REMAP',
      'PLATFORM_UNRESOLVED',
      'ADD_FAILED',
      'INVALID_ROW'
    )
  );

CREATE INDEX IX_COLL_CSV_IMPORTS_USER
  ON RPG_CLUB_COLLECTION_CSV_IMPORTS (USER_ID, STATUS);
CREATE INDEX IX_COLL_CSV_ITEMS_IMPORT
  ON RPG_CLUB_COLLECTION_CSV_IMPORT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX);

CREATE OR REPLACE TRIGGER TRG_COLL_CSV_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_COLLECTION_CSV_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
