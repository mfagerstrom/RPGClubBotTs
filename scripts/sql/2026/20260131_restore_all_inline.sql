-- 20260131_restore_all_inline.sql
-- Generated from scripts/sql by file mtime order
whenever sqlerror continue
set define off
set echo on
set feedback on
set timing on

-- BEGIN scripts/sql/2025/20251115_add_nomination_reminder_flags.sql
-- Adds reminder tracking flags to BOT_VOTING_INFO so the bot knows which
-- automated nomination reminders were already delivered.
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'BOT_VOTING_INFO'
     AND COLUMN_NAME = 'FIVE_DAY_REMINDER_SENT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE BOT_VOTING_INFO ADD (FIVE_DAY_REMINDER_SENT NUMBER(1) DEFAULT 0 NOT NULL)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'BOT_VOTING_INFO'
     AND COLUMN_NAME = 'ONE_DAY_REMINDER_SENT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE BOT_VOTING_INFO ADD (ONE_DAY_REMINDER_SENT NUMBER(1) DEFAULT 0 NOT NULL)';
  END IF;
END;
/

-- Existing rows receive the default value automatically, but run this update if
-- you created the columns without the DEFAULT clause.
UPDATE BOT_VOTING_INFO
   SET FIVE_DAY_REMINDER_SENT = NVL(FIVE_DAY_REMINDER_SENT, 0),
       ONE_DAY_REMINDER_SENT = NVL(ONE_DAY_REMINDER_SENT, 0);

COMMIT;
-- END scripts/sql/2025/20251115_add_nomination_reminder_flags.sql

-- BEGIN scripts/sql/2025/20251117_add_multi_game_support_to_nrgotm.sql
select * from nr_gotm_entries;

update nr_gotm_entries
set round_number = 130, month_year = 'September 20205', game_index = 1
where round_number = 131;

commit;

DECLARE
  v_count NUMBER := 0;
BEGIN
  BEGIN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES DROP PRIMARY KEY';
  EXCEPTION
    WHEN OTHERS THEN
      IF SQLCODE != -2443 THEN
        RAISE;
      END IF;
  END;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES'
     AND COLUMN_NAME = 'NR_GOTM_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES ADD (NR_GOTM_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_CONSTRAINTS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES'
     AND CONSTRAINT_TYPE = 'P';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES ADD CONSTRAINT PK_NR_GOTM_ENTRIES_ID PRIMARY KEY (NR_GOTM_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_NR_GOTM_ENTRIES_RND_IDX';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UX_NR_GOTM_ENTRIES_RND_IDX ON NR_GOTM_ENTRIES (ROUND_NUMBER, GAME_INDEX)';
  END IF;
END;
/

-- END scripts/sql/2025/20251117_add_multi_game_support_to_nrgotm.sql

-- BEGIN scripts/sql/2025/20251118_create_nominations.sql
-- Creates nomination tables for upcoming GOTM and NR-GOTM rounds.
-- Each user may hold one nomination per round; rows track the target round (current+1),
-- nominator user id, game title, and timestamp.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GOTM_NOMINATIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GOTM_NOMINATIONS (
        NOMINATION_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
        ROUND_NUMBER NUMBER NOT NULL,
        USER_ID VARCHAR2(64) NOT NULL,
        GAME_TITLE VARCHAR2(256) NOT NULL,
        NOMINATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_CONSTRAINTS
   WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
     AND CONSTRAINT_TYPE = 'P';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_NOMINATIONS ADD CONSTRAINT PK_GOTM_NOMINATIONS PRIMARY KEY (NOMINATION_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_GOTM_NOMINATIONS_ROUND_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UX_GOTM_NOMINATIONS_ROUND_USER ON GOTM_NOMINATIONS (ROUND_NUMBER, USER_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IX_GOTM_NOMINATIONS_ROUND';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_GOTM_NOMINATIONS_ROUND ON GOTM_NOMINATIONS (ROUND_NUMBER)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE NR_GOTM_NOMINATIONS (
        NOMINATION_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
        ROUND_NUMBER NUMBER NOT NULL,
        USER_ID VARCHAR2(64) NOT NULL,
        GAME_TITLE VARCHAR2(256) NOT NULL,
        NOMINATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_CONSTRAINTS
   WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
     AND CONSTRAINT_TYPE = 'P';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_NOMINATIONS ADD CONSTRAINT PK_NR_GOTM_NOMINATIONS PRIMARY KEY (NOMINATION_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_NR_GOTM_NOMS_ROUND_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UX_NR_GOTM_NOMS_ROUND_USER ON NR_GOTM_NOMINATIONS (ROUND_NUMBER, USER_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IX_NR_GOTM_NOMS_ROUND';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_NR_GOTM_NOMS_ROUND ON NR_GOTM_NOMINATIONS (ROUND_NUMBER)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251118_create_nominations.sql

-- BEGIN scripts/sql/2025/20251118_seed_gotm_noms_round133.sql
-- Seeds GOTM nominations for round 133 from prior bot data.
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
     AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE q'[
DECLARE
  v_round NUMBER := 133;
BEGIN
  MERGE INTO GOTM_NOMINATIONS t
  USING (SELECT v_round AS ROUND_NUMBER,
               '242859093377810433' AS USER_ID,
               'The Hundred Line: Last Defense Academy' AS GAME_TITLE
          FROM dual) src
     ON (t.ROUND_NUMBER = src.ROUND_NUMBER AND t.USER_ID = src.USER_ID)
   WHEN MATCHED THEN
     UPDATE SET t.GAME_TITLE = src.GAME_TITLE, t.NOMINATED_AT = SYSTIMESTAMP
   WHEN NOT MATCHED THEN
     INSERT (ROUND_NUMBER, USER_ID, GAME_TITLE, NOMINATED_AT)
     VALUES (src.ROUND_NUMBER, src.USER_ID, src.GAME_TITLE, SYSTIMESTAMP);

  MERGE INTO GOTM_NOMINATIONS t
  USING (SELECT v_round AS ROUND_NUMBER,
               '1330369244088504352' AS USER_ID,
               'Octopath Traveler 0' AS GAME_TITLE
          FROM dual) src
     ON (t.ROUND_NUMBER = src.ROUND_NUMBER AND t.USER_ID = src.USER_ID)
   WHEN MATCHED THEN
     UPDATE SET t.GAME_TITLE = src.GAME_TITLE, t.NOMINATED_AT = SYSTIMESTAMP
   WHEN NOT MATCHED THEN
     INSERT (ROUND_NUMBER, USER_ID, GAME_TITLE, NOMINATED_AT)
     VALUES (src.ROUND_NUMBER, src.USER_ID, src.GAME_TITLE, SYSTIMESTAMP);

  MERGE INTO GOTM_NOMINATIONS t
  USING (SELECT v_round AS ROUND_NUMBER,
               '152165643616124928' AS USER_ID,
               'Demeo x Dungeons & Dragons Battlemarked' AS GAME_TITLE
          FROM dual) src
     ON (t.ROUND_NUMBER = src.ROUND_NUMBER AND t.USER_ID = src.USER_ID)
   WHEN MATCHED THEN
     UPDATE SET t.GAME_TITLE = src.GAME_TITLE, t.NOMINATED_AT = SYSTIMESTAMP
   WHEN NOT MATCHED THEN
     INSERT (ROUND_NUMBER, USER_ID, GAME_TITLE, NOMINATED_AT)
     VALUES (src.ROUND_NUMBER, src.USER_ID, src.GAME_TITLE, SYSTIMESTAMP);

  MERGE INTO GOTM_NOMINATIONS t
  USING (SELECT v_round AS ROUND_NUMBER,
               '314394794673569805' AS USER_ID,
               'Disgaea 4: A Promise Unforgotten' AS GAME_TITLE
          FROM dual) src
     ON (t.ROUND_NUMBER = src.ROUND_NUMBER AND t.USER_ID = src.USER_ID)
   WHEN MATCHED THEN
     UPDATE SET t.GAME_TITLE = src.GAME_TITLE, t.NOMINATED_AT = SYSTIMESTAMP
   WHEN NOT MATCHED THEN
     INSERT (ROUND_NUMBER, USER_ID, GAME_TITLE, NOMINATED_AT)
     VALUES (src.ROUND_NUMBER, src.USER_ID, src.GAME_TITLE, SYSTIMESTAMP);

  DBMS_OUTPUT.PUT_LINE('Upserted GOTM nominations for round ' || v_round);
END;
]';
  END IF;
END;
/
COMMIT;
-- END scripts/sql/2025/20251118_seed_gotm_noms_round133.sql

-- BEGIN scripts/sql/2025/20251119_add_gotm_images.sql
-- Add image blob storage to GOTM and NR-GOTM entries.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_ENTRIES'
     AND COLUMN_NAME = 'IMAGE_BLOB';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_ENTRIES ADD (IMAGE_BLOB BLOB, IMAGE_MIME_TYPE VARCHAR2(128))';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES'
     AND COLUMN_NAME = 'IMAGE_BLOB';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES ADD (IMAGE_BLOB BLOB, IMAGE_MIME_TYPE VARCHAR2(128))';
  END IF;
END;
/

-- Note: IMAGE_BLOB + IMAGE_MIME_TYPE are optional and may be null.
-- END scripts/sql/2025/20251119_add_gotm_images.sql

-- BEGIN scripts/sql/2025/20251119_create_rpg_users.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_USERS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_USERS (
        USER_ID           VARCHAR2(30) PRIMARY KEY,
        IS_BOT            NUMBER(1,0) DEFAULT 0 NOT NULL,
        USERNAME          VARCHAR2(100),
        GLOBAL_NAME       VARCHAR2(100),
        AVATAR_BLOB       BLOB,
        SERVER_JOINED_AT  TIMESTAMP WITH TIME ZONE,
        LAST_SEEN_AT      TIMESTAMP WITH TIME ZONE,
        LAST_FETCHED_AT   TIMESTAMP WITH TIME ZONE,
        ROLE_ADMIN        NUMBER(1,0) DEFAULT 0 NOT NULL,
        ROLE_MODERATOR    NUMBER(1,0) DEFAULT 0 NOT NULL,
        ROLE_REGULAR      NUMBER(1,0) DEFAULT 0 NOT NULL,
        ROLE_MEMBER       NUMBER(1,0) DEFAULT 0 NOT NULL,
        ROLE_NEWCOMER     NUMBER(1,0) DEFAULT 0 NOT NULL,
        CREATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;
END;
/

-- Keep UPDATED_AT fresh on updates
CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_UPD
BEFORE UPDATE ON RPG_CLUB_USERS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

-- Optional: view to show “member duration” as years/months/days since join
CREATE OR REPLACE VIEW RPG_CLUB_USERS_MEMBERSHIP_V AS
SELECT
  USER_ID,
  IS_BOT,
  USERNAME,
  GLOBAL_NAME,
  SERVER_JOINED_AT,
  LAST_SEEN_AT,
  LAST_FETCHED_AT,
  ROLE_ADMIN,
  ROLE_MODERATOR,
  ROLE_REGULAR,
  ROLE_MEMBER,
  ROLE_NEWCOMER,
  FLOOR(MONTHS_BETWEEN(SYSTIMESTAMP, SERVER_JOINED_AT) / 12) AS YEARS,
  MOD(FLOOR(MONTHS_BETWEEN(SYSTIMESTAMP, SERVER_JOINED_AT)), 12) AS MONTHS,
  FLOOR(
    SYSTIMESTAMP
    - ADD_MONTHS(SERVER_JOINED_AT, FLOOR(MONTHS_BETWEEN(SYSTIMESTAMP, SERVER_JOINED_AT)))
  ) AS DAYS
FROM RPG_CLUB_USERS;

commit;
-- END scripts/sql/2025/20251119_create_rpg_users.sql

-- BEGIN scripts/sql/2025/20251119_create_user_history.sql
-- History tables to track Discord user nickname and avatar changes.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_USER_NICK_HISTORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_USER_NICK_HISTORY (
        EVENT_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        USER_ID       VARCHAR2(30) NOT NULL,
        OLD_NICK      VARCHAR2(100),
        NEW_NICK      VARCHAR2(100),
        CHANGED_AT    TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IX_RPG_CLUB_USER_NICK_HISTORY_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_RPG_CLUB_USER_NICK_HISTORY_USER ON RPG_CLUB_USER_NICK_HISTORY (USER_ID, CHANGED_AT)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_USER_AVATAR_HISTORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_USER_AVATAR_HISTORY (
        EVENT_ID      NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        USER_ID       VARCHAR2(30) NOT NULL,
        AVATAR_HASH   VARCHAR2(128),
        AVATAR_URL    VARCHAR2(512),
        AVATAR_BLOB   BLOB,
        CHANGED_AT    TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IX_RPG_CLUB_USER_AVATAR_HISTORY_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_RPG_CLUB_USER_AVATAR_HISTORY_USER ON RPG_CLUB_USER_AVATAR_HISTORY (USER_ID, CHANGED_AT)';
  END IF;
END;
/

-- Trigger: log nickname/global name changes
CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_NICK_HIST
AFTER UPDATE OF USERNAME, GLOBAL_NAME ON RPG_CLUB_USERS
FOR EACH ROW
DECLARE
  l_old VARCHAR2(100);
  l_new VARCHAR2(100);
BEGIN
  l_old := NVL(:OLD.GLOBAL_NAME, :OLD.USERNAME);
  l_new := NVL(:NEW.GLOBAL_NAME, :NEW.USERNAME);

  IF NVL(l_old, '#NULL#') != NVL(l_new, '#NULL#') THEN
    INSERT INTO RPG_CLUB_USER_NICK_HISTORY (USER_ID, OLD_NICK, NEW_NICK, CHANGED_AT)
    VALUES (:NEW.USER_ID, l_old, l_new, SYSTIMESTAMP);
  END IF;
END;
/

-- Trigger: log avatar blob changes
CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_AVATAR_HIST
AFTER UPDATE ON RPG_CLUB_USERS
FOR EACH ROW
DECLARE
  l_diff INTEGER := 0;
BEGIN
  -- Only act when the avatar blob changed
  IF :OLD.AVATAR_BLOB IS NULL AND :NEW.AVATAR_BLOB IS NULL THEN
    RETURN;
  ELSIF :OLD.AVATAR_BLOB IS NULL OR :NEW.AVATAR_BLOB IS NULL THEN
    l_diff := 1;
  ELSE
    l_diff := DBMS_LOB.COMPARE(:OLD.AVATAR_BLOB, :NEW.AVATAR_BLOB);
  END IF;

  IF l_diff <> 0 THEN
    INSERT INTO RPG_CLUB_USER_AVATAR_HISTORY (USER_ID, AVATAR_HASH, AVATAR_URL, AVATAR_BLOB, CHANGED_AT)
    VALUES (:NEW.USER_ID, NULL, NULL, :NEW.AVATAR_BLOB, SYSTIMESTAMP);
  END IF;
END;
/
-- END scripts/sql/2025/20251119_create_user_history.sql

-- BEGIN scripts/sql/2025/20251120_add_message_count_to_rpg_club_users.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'RPG_CLUB_USERS'
     AND COLUMN_NAME = 'MESSAGE_COUNT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_USERS ADD (MESSAGE_COUNT NUMBER(10,0) DEFAULT 0)';
  END IF;
END;
/

-- Backfill any NULLs to 0 for safety
UPDATE RPG_CLUB_USERS
   SET MESSAGE_COUNT = 0
 WHERE MESSAGE_COUNT IS NULL;

commit;
-- END scripts/sql/2025/20251120_add_message_count_to_rpg_club_users.sql

-- BEGIN scripts/sql/2025/20251120_create_user_reminders.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'USER_REMINDERS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE USER_REMINDERS (
        REMINDER_ID NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        USER_ID VARCHAR2(32) NOT NULL,
        REMIND_AT TIMESTAMP WITH TIME ZONE NOT NULL,
        CONTENT VARCHAR2(400) NOT NULL,
        SENT_AT TIMESTAMP WITH TIME ZONE NULL,
        CREATED_AT TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_USER_REMINDERS_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX UX_USER_REMINDERS_USER ON USER_REMINDERS (USER_ID, REMIND_AT)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_USER_REMINDERS_DUE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX UX_USER_REMINDERS_DUE ON USER_REMINDERS (SENT_AT, REMIND_AT)';
  END IF;
END;
/
-- END scripts/sql/2025/20251120_create_user_reminders.sql

-- BEGIN scripts/sql/2025/20251121_create_user_channel_message_counts.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_USER_CHANNEL_COUNTS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_USER_CHANNEL_COUNTS (
        USER_ID         VARCHAR2(30) NOT NULL,
        CHANNEL_ID      VARCHAR2(30) NOT NULL,
        MESSAGE_COUNT   NUMBER(12,0) DEFAULT 0 NOT NULL,
        LAST_SCANNED_AT TIMESTAMP WITH TIME ZONE,
        CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        CONSTRAINT PK_RPG_CLUB_USER_CHANNEL_COUNTS PRIMARY KEY (USER_ID, CHANNEL_ID)
      )';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USER_CHANNEL_COUNTS_UPD
BEFORE UPDATE ON RPG_CLUB_USER_CHANNEL_COUNTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

commit;
-- END scripts/sql/2025/20251121_create_user_channel_message_counts.sql

-- BEGIN scripts/sql/2025/20251128_expand_rpg_club_users_profiles.sql
-- Expand RPG_CLUB_USERS with profile/social fields
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'RPG_CLUB_USERS'
     AND COLUMN_NAME = 'COMPLETIONATOR_URL';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_USERS ADD (COMPLETIONATOR_URL VARCHAR2(512), PSN_USERNAME VARCHAR2(100), XBL_USERNAME VARCHAR2(100), NSW_FRIEND_CODE VARCHAR2(50), STEAM_URL VARCHAR2(512))';
  END IF;
END;
/
-- END scripts/sql/2025/20251128_expand_rpg_club_users_profiles.sql

-- BEGIN scripts/sql/2025/20251128_table_info_for_documentation.sql
SELECT column_id, column_name, data_type, data_length, data_precision, data_scale,
       nullable, data_default
FROM   all_tab_columns
WHERE  table_name = 'GOTM_NOMINATIONS'
ORDER  BY column_id;

SELECT c.constraint_name, c.r_constraint_name AS referenced_constraint,
       cc.column_name, rc.table_name AS referenced_table
FROM   all_constraints c
JOIN   all_cons_columns cc
  ON   c.owner = cc.owner AND c.constraint_name = cc.constraint_name
JOIN   all_constraints rc
  ON   rc.owner = c.owner AND rc.constraint_name = c.r_constraint_name
WHERE  c.table_name = 'GOTM_NOMINATIONS'
AND    c.constraint_type = 'R'
ORDER  BY c.constraint_name, cc.position;

SELECT index_name, column_name, column_position
FROM   all_ind_columns
WHERE  table_name = 'GOTM_NOMINATIONS'
ORDER  BY index_name, column_position;

SELECT trigger_name, triggering_event, status
FROM   all_triggers
WHERE  table_name = 'GOTM_NOMINATIONS';



-- END scripts/sql/2025/20251128_table_info_for_documentation.sql

-- BEGIN scripts/sql/2025/20251205_add_server_left_at.sql
-- Add SERVER_LEFT_AT to track when a member departs the server
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'RPG_CLUB_USERS'
     AND COLUMN_NAME = 'SERVER_LEFT_AT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_USERS ADD (SERVER_LEFT_AT TIMESTAMP(6) WITH TIME ZONE NULL)';
  END IF;
END;
/
-- END scripts/sql/2025/20251205_add_server_left_at.sql

-- BEGIN scripts/sql/2025/20251207_create_rpg_club_users_history.sql
-- Create audit/history table for RPG_CLUB_USERS
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_USERS_HIST';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_USERS_HIST (
        HISTORY_ID        NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        USER_ID           VARCHAR2(30) NOT NULL,
        IS_BOT            NUMBER(1,0),
        USERNAME          VARCHAR2(100),
        GLOBAL_NAME       VARCHAR2(100),
        AVATAR_BLOB       BLOB,
        SERVER_JOINED_AT  TIMESTAMP(6) WITH TIME ZONE,
        SERVER_LEFT_AT    TIMESTAMP(6) WITH TIME ZONE,
        LAST_SEEN_AT      TIMESTAMP(6) WITH TIME ZONE,
        LAST_FETCHED_AT   TIMESTAMP(6) WITH TIME ZONE,
        ROLE_ADMIN        NUMBER(1,0),
        ROLE_MODERATOR    NUMBER(1,0),
        ROLE_REGULAR      NUMBER(1,0),
        ROLE_MEMBER       NUMBER(1,0),
        ROLE_NEWCOMER     NUMBER(1,0),
        MESSAGE_COUNT     NUMBER(10,0),
        COMPLETIONATOR_URL VARCHAR2(512),
        PSN_USERNAME      VARCHAR2(100),
        XBL_USERNAME      VARCHAR2(100),
        NSW_FRIEND_CODE   VARCHAR2(50),
        STEAM_URL         VARCHAR2(512),
        PROFILE_IMAGE     BLOB,
        PROFILE_IMAGE_AT  TIMESTAMP(6) WITH TIME ZONE,
        CREATED_AT        TIMESTAMP(6) WITH TIME ZONE,
        UPDATED_AT        TIMESTAMP(6) WITH TIME ZONE,
        ACTION_TYPE       CHAR(1) NOT NULL,
        ACTIONED_AT       TIMESTAMP(6) WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IDX_RPG_CLUB_USERS_HIST_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_RPG_CLUB_USERS_HIST_USER ON RPG_CLUB_USERS_HIST (USER_ID)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_AUD
AFTER INSERT OR UPDATE OR DELETE ON RPG_CLUB_USERS
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME, AVATAR_BLOB,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :NEW.USER_ID, :NEW.IS_BOT, :NEW.USERNAME, :NEW.GLOBAL_NAME, :NEW.AVATAR_BLOB,
      :NEW.SERVER_JOINED_AT, :NEW.SERVER_LEFT_AT, :NEW.LAST_SEEN_AT, :NEW.LAST_FETCHED_AT,
      :NEW.ROLE_ADMIN, :NEW.ROLE_MODERATOR, :NEW.ROLE_REGULAR, :NEW.ROLE_MEMBER, :NEW.ROLE_NEWCOMER,
      :NEW.MESSAGE_COUNT, :NEW.COMPLETIONATOR_URL, :NEW.PSN_USERNAME, :NEW.XBL_USERNAME, :NEW.NSW_FRIEND_CODE,
      :NEW.STEAM_URL, :NEW.CREATED_AT, :NEW.UPDATED_AT,
      'I'
    );
  ELSIF UPDATING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME, AVATAR_BLOB,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :OLD.USER_ID, :OLD.IS_BOT, :OLD.USERNAME, :OLD.GLOBAL_NAME, :OLD.AVATAR_BLOB,
      :OLD.SERVER_JOINED_AT, :OLD.SERVER_LEFT_AT, :OLD.LAST_SEEN_AT, :OLD.LAST_FETCHED_AT,
      :OLD.ROLE_ADMIN, :OLD.ROLE_MODERATOR, :OLD.ROLE_REGULAR, :OLD.ROLE_MEMBER, :OLD.ROLE_NEWCOMER,
      :OLD.MESSAGE_COUNT, :OLD.COMPLETIONATOR_URL, :OLD.PSN_USERNAME, :OLD.XBL_USERNAME, :OLD.NSW_FRIEND_CODE,
      :OLD.STEAM_URL, :OLD.CREATED_AT, :OLD.UPDATED_AT,
      'U'
    );
  ELSIF DELETING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME, AVATAR_BLOB,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :OLD.USER_ID, :OLD.IS_BOT, :OLD.USERNAME, :OLD.GLOBAL_NAME, :OLD.AVATAR_BLOB,
      :OLD.SERVER_JOINED_AT, :OLD.SERVER_LEFT_AT, :OLD.LAST_SEEN_AT, :OLD.LAST_FETCHED_AT,
      :OLD.ROLE_ADMIN, :OLD.ROLE_MODERATOR, :OLD.ROLE_REGULAR, :OLD.ROLE_MEMBER, :OLD.ROLE_NEWCOMER,
      :OLD.MESSAGE_COUNT, :OLD.COMPLETIONATOR_URL, :OLD.PSN_USERNAME, :OLD.XBL_USERNAME, :OLD.NSW_FRIEND_CODE,
      :OLD.STEAM_URL, :OLD.CREATED_AT, :OLD.UPDATED_AT,
      'D'
    );
  END IF;
END;
/
-- END scripts/sql/2025/20251207_create_rpg_club_users_history.sql

-- BEGIN scripts/sql/2025/20251208_add_gamedb_ids_to_gotm.sql
-- Add GameDB linkage columns to GOTM and NR-GOTM entry tables

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_ENTRIES'
     AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_ENTRIES ADD GAMEDB_GAME_ID NUMBER';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES'
     AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES ADD GAMEDB_GAME_ID NUMBER';
  END IF;
END;
/
-- END scripts/sql/2025/20251208_add_gamedb_ids_to_gotm.sql

-- BEGIN scripts/sql/2025/20251208_add_is_noisy_to_reminders.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'USER_REMINDERS'
     AND COLUMN_NAME = 'IS_NOISY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_REMINDERS ADD (IS_NOISY NUMBER(1) DEFAULT 0 NOT NULL)';
  END IF;
END;
/
-- END scripts/sql/2025/20251208_add_is_noisy_to_reminders.sql

-- BEGIN scripts/sql/2025/20251208_add_nomination_reason.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
     AND COLUMN_NAME = 'REASON';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_NOMINATIONS ADD (REASON VARCHAR2(250))';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
     AND COLUMN_NAME = 'REASON';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_NOMINATIONS ADD (REASON VARCHAR2(250))';
  END IF;
END;
/

commit;
-- END scripts/sql/2025/20251208_add_nomination_reason.sql

-- BEGIN scripts/sql/2025/20251208_create_game_library.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'REGION_DEFINITIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE REGION_DEFINITIONS (
        REGION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        REGION_CODE VARCHAR2(10) NOT NULL UNIQUE,
        REGION_NAME VARCHAR2(100) NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'PLATFORM_DEFINITIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE PLATFORM_DEFINITIONS (
        PLATFORM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        PLATFORM_CODE VARCHAR2(20) NOT NULL UNIQUE,
        PLATFORM_NAME VARCHAR2(100) NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GAMES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMES (
        GAME_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        TITLE VARCHAR2(255) NOT NULL UNIQUE,
        DESCRIPTION CLOB,
        IMAGE_DATA BLOB,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GAME_RELEASES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAME_RELEASES (
        RELEASE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        GAME_ID NUMBER NOT NULL,
        PLATFORM_ID NUMBER NOT NULL,
        REGION_ID NUMBER NOT NULL,
        FORMAT VARCHAR2(20) CHECK (FORMAT IN (''Physical'', ''Digital'')),
        RELEASE_DATE DATE,
        NOTES VARCHAR2(255),
        CONSTRAINT FK_GR_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GR_PLATFORM FOREIGN KEY (PLATFORM_ID) REFERENCES PLATFORM_DEFINITIONS(PLATFORM_ID),
        CONSTRAINT FK_GR_REGION FOREIGN KEY (REGION_ID) REFERENCES REGION_DEFINITIONS(REGION_ID)
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IDX_GR_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GR_GAME ON GAME_RELEASES(GAME_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IDX_GR_PLATFORM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GR_PLATFORM ON GAME_RELEASES(PLATFORM_ID)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IDX_GR_REGION';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GR_REGION ON GAME_RELEASES(REGION_ID)';
  END IF;
END;
/

MERGE INTO REGION_DEFINITIONS t
USING (SELECT 'NA' AS REGION_CODE, 'North America' AS REGION_NAME FROM dual) src
ON (t.REGION_CODE = src.REGION_CODE)
WHEN NOT MATCHED THEN
  INSERT (REGION_CODE, REGION_NAME)
  VALUES (src.REGION_CODE, src.REGION_NAME);

MERGE INTO REGION_DEFINITIONS t
USING (SELECT 'EU' AS REGION_CODE, 'Europe' AS REGION_NAME FROM dual) src
ON (t.REGION_CODE = src.REGION_CODE)
WHEN NOT MATCHED THEN
  INSERT (REGION_CODE, REGION_NAME)
  VALUES (src.REGION_CODE, src.REGION_NAME);

MERGE INTO REGION_DEFINITIONS t
USING (SELECT 'JP' AS REGION_CODE, 'Japan' AS REGION_NAME FROM dual) src
ON (t.REGION_CODE = src.REGION_CODE)
WHEN NOT MATCHED THEN
  INSERT (REGION_CODE, REGION_NAME)
  VALUES (src.REGION_CODE, src.REGION_NAME);

MERGE INTO REGION_DEFINITIONS t
USING (SELECT 'WW' AS REGION_CODE, 'Worldwide' AS REGION_NAME FROM dual) src
ON (t.REGION_CODE = src.REGION_CODE)
WHEN NOT MATCHED THEN
  INSERT (REGION_CODE, REGION_NAME)
  VALUES (src.REGION_CODE, src.REGION_NAME);

MERGE INTO PLATFORM_DEFINITIONS t
USING (SELECT 'SWITCH' AS PLATFORM_CODE, 'Nintendo Switch' AS PLATFORM_NAME FROM dual) src
ON (t.PLATFORM_CODE = src.PLATFORM_CODE)
WHEN NOT MATCHED THEN
  INSERT (PLATFORM_CODE, PLATFORM_NAME)
  VALUES (src.PLATFORM_CODE, src.PLATFORM_NAME);

MERGE INTO PLATFORM_DEFINITIONS t
USING (SELECT 'PS5' AS PLATFORM_CODE, 'PlayStation 5' AS PLATFORM_NAME FROM dual) src
ON (t.PLATFORM_CODE = src.PLATFORM_CODE)
WHEN NOT MATCHED THEN
  INSERT (PLATFORM_CODE, PLATFORM_NAME)
  VALUES (src.PLATFORM_CODE, src.PLATFORM_NAME);

MERGE INTO PLATFORM_DEFINITIONS t
USING (SELECT 'PS4' AS PLATFORM_CODE, 'PlayStation 4' AS PLATFORM_NAME FROM dual) src
ON (t.PLATFORM_CODE = src.PLATFORM_CODE)
WHEN NOT MATCHED THEN
  INSERT (PLATFORM_CODE, PLATFORM_NAME)
  VALUES (src.PLATFORM_CODE, src.PLATFORM_NAME);

MERGE INTO PLATFORM_DEFINITIONS t
USING (SELECT 'PC' AS PLATFORM_CODE, 'PC (Windows/Linux/Mac)' AS PLATFORM_NAME FROM dual) src
ON (t.PLATFORM_CODE = src.PLATFORM_CODE)
WHEN NOT MATCHED THEN
  INSERT (PLATFORM_CODE, PLATFORM_NAME)
  VALUES (src.PLATFORM_CODE, src.PLATFORM_NAME);

MERGE INTO PLATFORM_DEFINITIONS t
USING (SELECT 'XBOX' AS PLATFORM_CODE, 'Xbox Series X|S' AS PLATFORM_NAME FROM dual) src
ON (t.PLATFORM_CODE = src.PLATFORM_CODE)
WHEN NOT MATCHED THEN
  INSERT (PLATFORM_CODE, PLATFORM_NAME)
  VALUES (src.PLATFORM_CODE, src.PLATFORM_NAME);
-- END scripts/sql/2025/20251208_create_game_library.sql

-- BEGIN scripts/sql/2025/20251208_create_public_reminders.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_PUBLIC_REMINDERS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_PUBLIC_REMINDERS (
        REMINDER_ID     NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        CHANNEL_ID      VARCHAR2(30) NOT NULL,
        MESSAGE         VARCHAR2(2000) NOT NULL,
        DUE_AT          TIMESTAMP WITH TIME ZONE NOT NULL,
        RECUR_EVERY     NUMBER,
        RECUR_UNIT      VARCHAR2(10),
        ENABLED         NUMBER(1,0) DEFAULT 1 NOT NULL,
        CREATED_BY      VARCHAR2(30),
        CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IX_RPG_CLUB_PUBLIC_REMINDERS_DUE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_RPG_CLUB_PUBLIC_REMINDERS_DUE ON RPG_CLUB_PUBLIC_REMINDERS (DUE_AT, ENABLED)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_PUBLIC_REMINDERS_UPD
BEFORE UPDATE ON RPG_CLUB_PUBLIC_REMINDERS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

commit;
-- END scripts/sql/2025/20251208_create_public_reminders.sql

-- BEGIN scripts/sql/2025/20251208_create_rss_feeds.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_RSS_FEEDS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_RSS_FEEDS (
        FEED_ID          NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        FEED_NAME        VARCHAR2(200),
        FEED_URL         VARCHAR2(512) NOT NULL,
        CHANNEL_ID       VARCHAR2(30) NOT NULL,
        INCLUDE_KEYWORDS VARCHAR2(4000),
        EXCLUDE_KEYWORDS VARCHAR2(4000),
        CREATED_AT       TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT       TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_RPG_CLUB_RSS_FEEDS_URL';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UX_RPG_CLUB_RSS_FEEDS_URL ON RPG_CLUB_RSS_FEEDS (FEED_URL)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_RSS_FEEDS_UPD
BEFORE UPDATE ON RPG_CLUB_RSS_FEEDS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'RPG_CLUB_RSS_FEED_ITEMS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_RSS_FEED_ITEMS (
        FEED_ID        NUMBER NOT NULL,
        ITEM_ID_HASH   VARCHAR2(128) NOT NULL,
        ITEM_GUID      VARCHAR2(512),
        ITEM_LINK      VARCHAR2(512),
        PUBLISHED_AT   TIMESTAMP WITH TIME ZONE,
        FIRST_SEEN_AT  TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        CONSTRAINT PK_RPG_CLUB_RSS_FEED_ITEMS PRIMARY KEY (FEED_ID, ITEM_ID_HASH)
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_CONSTRAINTS
   WHERE TABLE_NAME = 'RPG_CLUB_RSS_FEED_ITEMS'
     AND CONSTRAINT_NAME = 'FK_RSS_FEED_ITEMS_FEED';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_RSS_FEED_ITEMS ADD CONSTRAINT FK_RSS_FEED_ITEMS_FEED FOREIGN KEY (FEED_ID) REFERENCES RPG_CLUB_RSS_FEEDS (FEED_ID)';
  END IF;
END;
/

commit;
-- END scripts/sql/2025/20251208_create_rss_feeds.sql

-- BEGIN scripts/sql/2025/20251208_drop_unique_index_rss_feeds.sql
-- Drop unique index on FEED_URL for existing deployments

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'UX_RPG_CLUB_RSS_FEEDS_URL';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'DROP INDEX UX_RPG_CLUB_RSS_FEEDS_URL';
  END IF;
END;
/

commit;
-- END scripts/sql/2025/20251208_drop_unique_index_rss_feeds.sql

-- BEGIN scripts/sql/2025/20251208_expand_game_library_for_igdb.sql
-- Add IGDB specific columns to GAMES
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMES'
    AND COLUMN_NAME = 'IGDB_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMES ADD IGDB_ID NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMES'
    AND COLUMN_NAME = 'SLUG';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMES ADD SLUG VARCHAR2(255)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMES'
    AND COLUMN_NAME = 'TOTAL_RATING';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMES ADD TOTAL_RATING NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMES'
    AND COLUMN_NAME = 'IGDB_URL';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMES ADD IGDB_URL VARCHAR2(512)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_CONSTRAINTS
   WHERE TABLE_NAME = 'GAMES'
     AND CONSTRAINT_NAME = 'UQ_GAMES_IGDB_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMES ADD CONSTRAINT UQ_GAMES_IGDB_ID UNIQUE (IGDB_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'PLATFORM_DEFINITIONS'
    AND COLUMN_NAME = 'IGDB_PLATFORM_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE PLATFORM_DEFINITIONS ADD IGDB_PLATFORM_ID NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'REGION_DEFINITIONS'
    AND COLUMN_NAME = 'IGDB_REGION_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE REGION_DEFINITIONS ADD IGDB_REGION_ID NUMBER';
  END IF;
END;
/

-- Update existing Region Mappings (IGDB Region IDs)
-- 1: Europe, 2: North America, 3: Australia, 4: NZ, 5: Japan, 6: China, 7: Asia, 8: Worldwide
UPDATE REGION_DEFINITIONS SET IGDB_REGION_ID = 2 WHERE REGION_CODE = 'NA';
UPDATE REGION_DEFINITIONS SET IGDB_REGION_ID = 1 WHERE REGION_CODE = 'EU';
UPDATE REGION_DEFINITIONS SET IGDB_REGION_ID = 5 WHERE REGION_CODE = 'JP';
UPDATE REGION_DEFINITIONS SET IGDB_REGION_ID = 8 WHERE REGION_CODE = 'WW';

-- Update existing Platform Mappings (Common IGDB Platform IDs)
UPDATE PLATFORM_DEFINITIONS SET IGDB_PLATFORM_ID = 130 WHERE PLATFORM_CODE = 'SWITCH';
UPDATE PLATFORM_DEFINITIONS SET IGDB_PLATFORM_ID = 167 WHERE PLATFORM_CODE = 'PS5';
UPDATE PLATFORM_DEFINITIONS SET IGDB_PLATFORM_ID = 48 WHERE PLATFORM_CODE = 'PS4';
UPDATE PLATFORM_DEFINITIONS SET IGDB_PLATFORM_ID = 6 WHERE PLATFORM_CODE = 'PC';
UPDATE PLATFORM_DEFINITIONS SET IGDB_PLATFORM_ID = 169 WHERE PLATFORM_CODE = 'XBOX'; -- Xbox Series X|S

-- Genres Tables
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GENRES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GENRES (
        GENRE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        IGDB_GENRE_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GAME_GENRES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAME_GENRES (
        GAME_ID NUMBER NOT NULL,
        GENRE_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_LIBRARY_GENRES PRIMARY KEY (GAME_ID, GENRE_ID),
        CONSTRAINT FK_GAME_LIBRARY_GENRES_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GAME_LIBRARY_GENRES_GENRE FOREIGN KEY (GENRE_ID) REFERENCES GENRES(GENRE_ID)
      )';
  END IF;
END;
/
-- END scripts/sql/2025/20251208_expand_game_library_for_igdb.sql

-- BEGIN scripts/sql/2025/20251208_gamedb_expanded_metadata.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_COMPANIES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_COMPANIES (
        COMPANY_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(255) NOT NULL,
        IGDB_COMPANY_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_COMPANIES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_COMPANIES (
        GAME_ID NUMBER NOT NULL,
        COMPANY_ID NUMBER NOT NULL,
        ROLE VARCHAR2(20) CHECK (ROLE IN (''Developer'', ''Publisher'')),
        CONSTRAINT PK_GAME_COMPANIES PRIMARY KEY (GAME_ID, COMPANY_ID, ROLE),
        CONSTRAINT FK_GC_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GC_COMPANY FOREIGN KEY (COMPANY_ID) REFERENCES GAMEDB_COMPANIES(COMPANY_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_THEMES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_THEMES (
        THEME_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        IGDB_THEME_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_THEMES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_THEMES (
        GAME_ID NUMBER NOT NULL,
        THEME_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_THEMES PRIMARY KEY (GAME_ID, THEME_ID),
        CONSTRAINT FK_GT_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GT_THEME FOREIGN KEY (THEME_ID) REFERENCES GAMEDB_THEMES(THEME_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_MODES_DEF';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_MODES_DEF (
        MODE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        IGDB_GAME_MODE_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_MODES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_MODES (
        GAME_ID NUMBER NOT NULL,
        MODE_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_MODES PRIMARY KEY (GAME_ID, MODE_ID),
        CONSTRAINT FK_GM_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GM_MODE FOREIGN KEY (MODE_ID) REFERENCES GAMEDB_GAME_MODES_DEF(MODE_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_PERSPECTIVES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_PERSPECTIVES (
        PERSPECTIVE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(100) NOT NULL,
        IGDB_PERSPECTIVE_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_PERSPECTIVES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_PERSPECTIVES (
        GAME_ID NUMBER NOT NULL,
        PERSPECTIVE_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_PERSPECTIVES PRIMARY KEY (GAME_ID, PERSPECTIVE_ID),
        CONSTRAINT FK_GP_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GP_PERSPECTIVE FOREIGN KEY (PERSPECTIVE_ID) REFERENCES GAMEDB_PERSPECTIVES(PERSPECTIVE_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_ENGINES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_ENGINES (
        ENGINE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(255) NOT NULL,
        IGDB_ENGINE_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_ENGINES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_ENGINES (
        GAME_ID NUMBER NOT NULL,
        ENGINE_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_ENGINES PRIMARY KEY (GAME_ID, ENGINE_ID),
        CONSTRAINT FK_GE_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GE_ENGINE FOREIGN KEY (ENGINE_ID) REFERENCES GAMEDB_ENGINES(ENGINE_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_FRANCHISES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_FRANCHISES (
        FRANCHISE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(255) NOT NULL,
        IGDB_FRANCHISE_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_GAME_FRANCHISES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_FRANCHISES (
        GAME_ID NUMBER NOT NULL,
        FRANCHISE_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAME_FRANCHISES PRIMARY KEY (GAME_ID, FRANCHISE_ID),
        CONSTRAINT FK_GF_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GF_FRANCHISE FOREIGN KEY (FRANCHISE_ID) REFERENCES GAMEDB_FRANCHISES(FRANCHISE_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TABLES WHERE TABLE_NAME = 'GAMEDB_COLLECTIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_COLLECTIONS (
        COLLECTION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        NAME VARCHAR2(255) NOT NULL,
        IGDB_COLLECTION_ID NUMBER UNIQUE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND COLUMN_NAME = 'COLLECTION_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD COLLECTION_ID NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND CONSTRAINT_NAME = 'FK_GAMES_COLLECTION';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD CONSTRAINT FK_GAMES_COLLECTION FOREIGN KEY (COLLECTION_ID) REFERENCES GAMEDB_COLLECTIONS(COLLECTION_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND COLUMN_NAME = 'PARENT_IGDB_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD PARENT_IGDB_ID NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND COLUMN_NAME = 'PARENT_GAME_NAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD PARENT_GAME_NAME VARCHAR2(255)';
  END IF;
END;
/
-- END scripts/sql/2025/20251208_gamedb_expanded_metadata.sql

-- BEGIN scripts/sql/2025/20251208_recreate_gamedb_schema.sql
-- Drop existing tables if they exist (Clean Slate)
BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_COMPANIES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_COMPANIES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_THEMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_THEMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_MODES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_MODES_DEF CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_PERSPECTIVES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_PERSPECTIVES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_ENGINES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_ENGINES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_FRANCHISES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_FRANCHISES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_COLLECTIONS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAME_GENRES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GENRES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_RELEASES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_GAMES CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_PLATFORMS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

BEGIN
   EXECUTE IMMEDIATE 'DROP TABLE GAMEDB_REGIONS CASCADE CONSTRAINTS';
EXCEPTION
   WHEN OTHERS THEN
      IF SQLCODE != -942 THEN RAISE; END IF;
END;
/

-- Create Region Definitions
CREATE TABLE GAMEDB_REGIONS (
    REGION_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    REGION_CODE VARCHAR2(10) NOT NULL UNIQUE,
    REGION_NAME VARCHAR2(100) NOT NULL,
    IGDB_REGION_ID NUMBER,
    CONSTRAINT UQ_GAMEDB_REGIONS_IGDB UNIQUE (IGDB_REGION_ID)
);

-- Create Platform Definitions
CREATE TABLE GAMEDB_PLATFORMS (
    PLATFORM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PLATFORM_CODE VARCHAR2(20) NOT NULL UNIQUE,
    PLATFORM_NAME VARCHAR2(100) NOT NULL,
    IGDB_PLATFORM_ID NUMBER,
    CONSTRAINT UQ_GAMEDB_PLATFORMS_IGDB UNIQUE (IGDB_PLATFORM_ID)
);

-- Create Games Table
CREATE TABLE GAMEDB_GAMES (
    GAME_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    TITLE VARCHAR2(255) NOT NULL UNIQUE,
    DESCRIPTION CLOB,
    IMAGE_DATA BLOB,
    IGDB_ID NUMBER,
    SLUG VARCHAR2(255),
    TOTAL_RATING NUMBER,
    IGDB_URL VARCHAR2(512),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT UQ_GAMEDB_GAMES_IGDB_ID UNIQUE (IGDB_ID)
);

CREATE OR REPLACE TRIGGER TRG_GAMEDB_GAMES_UPD
BEFORE UPDATE ON GAMEDB_GAMES
FOR EACH ROW
BEGIN
   :NEW.UPDATED_AT := CURRENT_TIMESTAMP;
END;
/

-- Create Game Releases Table
CREATE TABLE GAMEDB_RELEASES (
    RELEASE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    GAME_ID NUMBER NOT NULL,
    PLATFORM_ID NUMBER NOT NULL,
    REGION_ID NUMBER NOT NULL,
    FORMAT VARCHAR2(20) CHECK (FORMAT IN ('Physical', 'Digital')),
    RELEASE_DATE DATE,
    NOTES VARCHAR2(255),
    CONSTRAINT FK_GAMEDB_RELEASES_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
    CONSTRAINT FK_GAMEDB_RELEASES_PLATFORM FOREIGN KEY (PLATFORM_ID) REFERENCES GAMEDB_PLATFORMS(PLATFORM_ID),
    CONSTRAINT FK_GAMEDB_RELEASES_REGION FOREIGN KEY (REGION_ID) REFERENCES GAMEDB_REGIONS(REGION_ID)
);

CREATE INDEX IDX_GAMEDB_RELEASES_GAME ON GAMEDB_RELEASES(GAME_ID);
CREATE INDEX IDX_GAMEDB_RELEASES_PLATFORM ON GAMEDB_RELEASES(PLATFORM_ID);
CREATE INDEX IDX_GAMEDB_RELEASES_REGION ON GAMEDB_RELEASES(REGION_ID);

-- Create Genres Table
CREATE TABLE GAMEDB_GENRES (
    GENRE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NAME VARCHAR2(100) NOT NULL,
    IGDB_GENRE_ID NUMBER UNIQUE
);

-- Create Game Genres Mapping Table (Many-to-Many)
CREATE TABLE GAMEDB_GAME_GENRES (
    GAME_ID NUMBER NOT NULL,
    GENRE_ID NUMBER NOT NULL,
    CONSTRAINT PK_GAMEDB_GAME_GENRES PRIMARY KEY (GAME_ID, GENRE_ID),
    CONSTRAINT FK_GAMEDB_GAME_GENRES_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
    CONSTRAINT FK_GAMEDB_GAME_GENRES_GENRE FOREIGN KEY (GENRE_ID) REFERENCES GAMEDB_GENRES(GENRE_ID)
);

-- Seed Initial Regions (with IGDB IDs)
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('NA', 'North America', 2);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('EU', 'Europe', 1);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('JP', 'Japan', 5);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('WW', 'Worldwide', 8);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('AUS', 'Australia', 3);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('NZ', 'New Zealand', 4);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('CN', 'China', 6);
INSERT INTO GAMEDB_REGIONS (REGION_CODE, REGION_NAME, IGDB_REGION_ID) VALUES ('AS', 'Asia', 7);

-- Seed Initial Platforms (with common IGDB IDs)
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('SWITCH', 'Nintendo Switch', 130);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PS5', 'PlayStation 5', 167);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PS4', 'PlayStation 4', 48);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('PC', 'PC (Windows/Linux/Mac)', 6);
INSERT INTO GAMEDB_PLATFORMS (PLATFORM_CODE, PLATFORM_NAME, IGDB_PLATFORM_ID) VALUES ('XBOX', 'Xbox Series X|S', 169);
-- END scripts/sql/2025/20251208_recreate_gamedb_schema.sql

-- BEGIN scripts/sql/2025/20251208_update_rpg_club_users_hist_trigger.sql
-- Rewrite TRG_RPG_CLUB_USERS_AUD to avoid storing avatars in the history table

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_USERS_AUD
AFTER INSERT OR UPDATE OR DELETE ON RPG_CLUB_USERS
FOR EACH ROW
BEGIN
  IF INSERTING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :NEW.USER_ID, :NEW.IS_BOT, :NEW.USERNAME, :NEW.GLOBAL_NAME,
      :NEW.SERVER_JOINED_AT, :NEW.SERVER_LEFT_AT, :NEW.LAST_SEEN_AT, :NEW.LAST_FETCHED_AT,
      :NEW.ROLE_ADMIN, :NEW.ROLE_MODERATOR, :NEW.ROLE_REGULAR, :NEW.ROLE_MEMBER, :NEW.ROLE_NEWCOMER,
      :NEW.MESSAGE_COUNT, :NEW.COMPLETIONATOR_URL, :NEW.PSN_USERNAME, :NEW.XBL_USERNAME, :NEW.NSW_FRIEND_CODE,
      :NEW.STEAM_URL, :NEW.CREATED_AT, :NEW.UPDATED_AT,
      'I'
    );
  ELSIF UPDATING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :OLD.USER_ID, :OLD.IS_BOT, :OLD.USERNAME, :OLD.GLOBAL_NAME,
      :OLD.SERVER_JOINED_AT, :OLD.SERVER_LEFT_AT, :OLD.LAST_SEEN_AT, :OLD.LAST_FETCHED_AT,
      :OLD.ROLE_ADMIN, :OLD.ROLE_MODERATOR, :OLD.ROLE_REGULAR, :OLD.ROLE_MEMBER, :OLD.ROLE_NEWCOMER,
      :OLD.MESSAGE_COUNT, :OLD.COMPLETIONATOR_URL, :OLD.PSN_USERNAME, :OLD.XBL_USERNAME, :OLD.NSW_FRIEND_CODE,
      :OLD.STEAM_URL, :OLD.CREATED_AT, :OLD.UPDATED_AT,
      'U'
    );
  ELSIF DELETING THEN
    INSERT INTO RPG_CLUB_USERS_HIST (
      USER_ID, IS_BOT, USERNAME, GLOBAL_NAME,
      SERVER_JOINED_AT, SERVER_LEFT_AT, LAST_SEEN_AT, LAST_FETCHED_AT,
      ROLE_ADMIN, ROLE_MODERATOR, ROLE_REGULAR, ROLE_MEMBER, ROLE_NEWCOMER,
      MESSAGE_COUNT, COMPLETIONATOR_URL, PSN_USERNAME, XBL_USERNAME, NSW_FRIEND_CODE,
      STEAM_URL, CREATED_AT, UPDATED_AT,
      ACTION_TYPE
    ) VALUES (
      :OLD.USER_ID, :OLD.IS_BOT, :OLD.USERNAME, :OLD.GLOBAL_NAME,
      :OLD.SERVER_JOINED_AT, :OLD.SERVER_LEFT_AT, :OLD.LAST_SEEN_AT, :OLD.LAST_FETCHED_AT,
      :OLD.ROLE_ADMIN, :OLD.ROLE_MODERATOR, :OLD.ROLE_REGULAR, :OLD.ROLE_MEMBER, :OLD.ROLE_NEWCOMER,
      :OLD.MESSAGE_COUNT, :OLD.COMPLETIONATOR_URL, :OLD.PSN_USERNAME, :OLD.XBL_USERNAME, :OLD.NSW_FRIEND_CODE,
      :OLD.STEAM_URL, :OLD.CREATED_AT, :OLD.UPDATED_AT,
      'D'
    );
  END IF;
END;
/

commit;
-- END scripts/sql/2025/20251208_update_rpg_club_users_hist_trigger.sql

-- BEGIN scripts/sql/2025/20251209_add_gamedb_id_to_nominations.sql
-- Adds GameDB linkage to nomination tables to align with GameDB-only workflow.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
     AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_NOMINATIONS ADD (GAMEDB_GAME_ID NUMBER NULL)';
  END IF;

  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
     AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_NOMINATIONS ADD (GAMEDB_GAME_ID NUMBER NULL)';
  END IF;
END;
/

-- Optional: index to support lookups by GameDB id if needed later.
-- CREATE INDEX IX_GOTM_NOMS_GAMEDB ON GOTM_NOMINATIONS (GAMEDB_GAME_ID);
-- CREATE INDEX IX_NR_GOTM_NOMS_GAMEDB ON NR_GOTM_NOMINATIONS (GAMEDB_GAME_ID);

COMMIT;
-- END scripts/sql/2025/20251209_add_gamedb_id_to_nominations.sql

-- BEGIN scripts/sql/2025/20251209_drop_gotm_titles_and_images.sql
-- Run this only after every GOTM/NR-GOTM row has a non-null GAMEDB_GAME_ID.
-- Drops legacy title/image columns in one statement per table.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_ENTRIES' AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_ENTRIES DROP COLUMN GAME_TITLE';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_ENTRIES' AND COLUMN_NAME = 'IMAGE_BLOB';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_ENTRIES DROP COLUMN IMAGE_BLOB';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'GOTM_ENTRIES' AND COLUMN_NAME = 'IMAGE_MIME_TYPE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_ENTRIES DROP COLUMN IMAGE_MIME_TYPE';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES' AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES DROP COLUMN GAME_TITLE';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES' AND COLUMN_NAME = 'IMAGE_BLOB';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES DROP COLUMN IMAGE_BLOB';
  END IF;

  SELECT COUNT(*) INTO v_count FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'NR_GOTM_ENTRIES' AND COLUMN_NAME = 'IMAGE_MIME_TYPE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_ENTRIES DROP COLUMN IMAGE_MIME_TYPE';
  END IF;
END;
/
-- END scripts/sql/2025/20251209_drop_gotm_titles_and_images.sql

-- BEGIN scripts/sql/2025/20251209_drop_nomination_game_titles.sql
-- Drops legacy GAME_TITLE columns now that nominations rely on GameDB metadata.
-- Ensure GAMEDB_GAME_ID is populated for all rows before running the NOT NULL change.

DECLARE
  v_count NUMBER := 0;
  v_nullable VARCHAR2(1);
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
    AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count > 0 THEN
    SELECT NULLABLE INTO v_nullable
    FROM USER_TAB_COLS
    WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
      AND COLUMN_NAME = 'GAMEDB_GAME_ID';
    IF v_nullable = 'Y' THEN
      SELECT COUNT(*)
        INTO v_count
        FROM GOTM_NOMINATIONS
       WHERE GAMEDB_GAME_ID IS NULL;
      IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE GOTM_NOMINATIONS MODIFY (GAMEDB_GAME_ID NOT NULL)';
      END IF;
    END IF;
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GOTM_NOMINATIONS'
    AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GOTM_NOMINATIONS DROP COLUMN GAME_TITLE';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
    AND COLUMN_NAME = 'GAMEDB_GAME_ID';
  IF v_count > 0 THEN
    SELECT NULLABLE INTO v_nullable
    FROM USER_TAB_COLS
    WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
      AND COLUMN_NAME = 'GAMEDB_GAME_ID';
    IF v_nullable = 'Y' THEN
      SELECT COUNT(*)
        INTO v_count
        FROM NR_GOTM_NOMINATIONS
       WHERE GAMEDB_GAME_ID IS NULL;
      IF v_count = 0 THEN
        EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_NOMINATIONS MODIFY (GAMEDB_GAME_ID NOT NULL)';
      END IF;
    END IF;
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'NR_GOTM_NOMINATIONS'
    AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE NR_GOTM_NOMINATIONS DROP COLUMN GAME_TITLE';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251209_drop_nomination_game_titles.sql

-- BEGIN scripts/sql/2025/20251209_prepare_gotm_gamedb_enforcement.sql
-- Pre-flight checks before dropping GOTM/NR-GOTM title/image columns.
-- Review and fix any rows returned here by setting GAMEDB_GAME_ID first.

DECLARE
  v_count NUMBER := 0;
  v_cursor SYS_REFCURSOR;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GOTM_ENTRIES'
    AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    OPEN v_cursor FOR 'SELECT ROUND_NUMBER, GAME_INDEX, GAME_TITLE, GAMEDB_GAME_ID FROM GOTM_ENTRIES WHERE GAMEDB_GAME_ID IS NULL';
  ELSE
    OPEN v_cursor FOR 'SELECT ROUND_NUMBER, GAME_INDEX, GAMEDB_GAME_ID FROM GOTM_ENTRIES WHERE GAMEDB_GAME_ID IS NULL';
  END IF;
  DBMS_SQL.RETURN_RESULT(v_cursor);

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'NR_GOTM_ENTRIES'
    AND COLUMN_NAME = 'GAME_TITLE';
  IF v_count > 0 THEN
    OPEN v_cursor FOR 'SELECT ROUND_NUMBER, GAME_INDEX, GAME_TITLE, GAMEDB_GAME_ID FROM NR_GOTM_ENTRIES WHERE GAMEDB_GAME_ID IS NULL';
  ELSE
    OPEN v_cursor FOR 'SELECT ROUND_NUMBER, GAME_INDEX, GAMEDB_GAME_ID FROM NR_GOTM_ENTRIES WHERE GAMEDB_GAME_ID IS NULL';
  END IF;
  DBMS_SQL.RETURN_RESULT(v_cursor);
END;
/

-- Example backfill update (replace placeholders, run only after verifying):
-- UPDATE GOTM_ENTRIES SET GAMEDB_GAME_ID = <id> WHERE ROUND_NUMBER = <round> AND GAME_INDEX = <idx>;
-- UPDATE NR_GOTM_ENTRIES SET GAMEDB_GAME_ID = <id> WHERE ROUND_NUMBER = <round> AND GAME_INDEX = <idx>;
-- COMMIT;
-- END scripts/sql/2025/20251209_prepare_gotm_gamedb_enforcement.sql

-- BEGIN scripts/sql/2025/20251210_add_skip_linking_flag.sql
-- Add skip flag so the bot can avoid re-prompting threads intentionally left unlinked.

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'THREADS'
    AND COLUMN_NAME = 'SKIP_LINKING';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE THREADS ADD (SKIP_LINKING CHAR(1) DEFAULT ''N'' CHECK (SKIP_LINKING IN (''Y'',''N'')))';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251210_add_skip_linking_flag.sql

-- BEGIN scripts/sql/2025/20251210_create_threads_table.sql
-- Track Now Playing forum threads and optionally link them to GameDB games.
-- Forum channel id: 1059875931356938240

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'THREADS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE THREADS (
        THREAD_ID          VARCHAR2(30) PRIMARY KEY,
        FORUM_CHANNEL_ID   VARCHAR2(30) NOT NULL,
        THREAD_NAME        VARCHAR2(200) NOT NULL,
        GAMEDB_GAME_ID     NUMBER NULL,
        IS_ARCHIVED        CHAR(1) DEFAULT ''N'' CHECK (IS_ARCHIVED IN (''Y'',''N'')),
        CREATED_AT         TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        LAST_SEEN_AT       TIMESTAMP WITH TIME ZONE
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'THREADS'
    AND CONSTRAINT_NAME = 'FK_THREADS_GAMEDB_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE THREADS ADD CONSTRAINT FK_THREADS_GAMEDB_GAME FOREIGN KEY (GAMEDB_GAME_ID) REFERENCES GAMEDB_GAMES (GAME_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_THREADS_GAMEDB';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_THREADS_GAMEDB ON THREADS (GAMEDB_GAME_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_THREADS_FORUM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_THREADS_FORUM ON THREADS (FORUM_CHANNEL_ID)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251210_create_threads_table.sql

-- BEGIN scripts/sql/2025/20251210_create_user_now_playing.sql
-- Track games users have marked as "Now Playing"

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'USER_NOW_PLAYING';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE USER_NOW_PLAYING (
        ENTRY_ID   NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        USER_ID    VARCHAR2(30) NOT NULL,
        TITLE      VARCHAR2(200) NOT NULL,
        ADDED_AT   TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD CONSTRAINT UQ_USER_NOW_PLAYING UNIQUE (USER_ID, TITLE)';
    EXECUTE IMMEDIATE 'CREATE INDEX IX_USER_NOW_PLAYING_USER ON USER_NOW_PLAYING (USER_ID)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251210_create_user_now_playing.sql

-- BEGIN scripts/sql/2025/20251210_recreate_user_now_playing_gamedb.sql
-- Recreate USER_NOW_PLAYING as GameDB-backed (no free text)

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_NOW_PLAYING'
    AND COLUMN_NAME = 'TITLE';
  IF v_count > 0 THEN
    BEGIN
      EXECUTE IMMEDIATE 'DROP TABLE USER_NOW_PLAYING CASCADE CONSTRAINTS';
    EXCEPTION
      WHEN OTHERS THEN
        IF SQLCODE != -942 THEN
          RAISE;
        END IF;
    END;

    EXECUTE IMMEDIATE '
      CREATE TABLE USER_NOW_PLAYING (
        ENTRY_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        USER_ID        VARCHAR2(30) NOT NULL,
        GAMEDB_GAME_ID NUMBER NOT NULL,
        ADDED_AT       TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';

    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD CONSTRAINT FK_USER_NOW_PLAYING_GAMEDB FOREIGN KEY (GAMEDB_GAME_ID) REFERENCES GAMEDB_GAMES (GAME_ID)';
    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD CONSTRAINT UQ_USER_NOW_PLAYING_GAMEDB UNIQUE (USER_ID, GAMEDB_GAME_ID)';
    EXECUTE IMMEDIATE 'CREATE INDEX IX_USER_NOW_PLAYING_USER ON USER_NOW_PLAYING (USER_ID)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2025/20251210_recreate_user_now_playing_gamedb.sql

-- BEGIN scripts/sql/2025/20251210_update_user_now_playing_gamedb.sql
-- Move USER_NOW_PLAYING to GameDB-backed entries (no free text)

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_NOW_PLAYING'
    AND COLUMN_NAME = 'TITLE';
  IF v_count > 0 THEN
    SELECT COUNT(*) INTO v_count
    FROM USER_TAB_COLS
    WHERE TABLE_NAME = 'USER_NOW_PLAYING'
      AND COLUMN_NAME = 'GAMEDB_GAME_ID';
    IF v_count = 0 THEN
      EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD (GAMEDB_GAME_ID NUMBER NULL)';
    END IF;

    SELECT COUNT(*) INTO v_count
    FROM USER_CONSTRAINTS
    WHERE TABLE_NAME = 'USER_NOW_PLAYING'
      AND CONSTRAINT_NAME = 'FK_USER_NOW_PLAYING_GAMEDB';
    IF v_count = 0 THEN
      EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD CONSTRAINT FK_USER_NOW_PLAYING_GAMEDB FOREIGN KEY (GAMEDB_GAME_ID) REFERENCES GAMEDB_GAMES (GAME_ID)';
    END IF;

    DECLARE
      v_name VARCHAR2(128);
    BEGIN
      SELECT constraint_name INTO v_name
      FROM user_constraints
      WHERE table_name = 'USER_NOW_PLAYING'
        AND constraint_type = 'U'
        AND constraint_name LIKE 'UQ_USER_NOW_PLAYING%';

      EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING DROP CONSTRAINT ' || v_name;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN NULL;
    END;

    SELECT COUNT(*) INTO v_count
    FROM USER_INDEXES
    WHERE INDEX_NAME = 'UQ_USER_NOW_PLAYING_GAMEDB';
    IF v_count = 0 THEN
      EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UQ_USER_NOW_PLAYING_GAMEDB ON USER_NOW_PLAYING (USER_ID, GAMEDB_GAME_ID)';
    END IF;
  END IF;
END;
/

-- Optional: existing rows without GAMEDB_GAME_ID will be ignored by new code paths.
COMMIT;
-- END scripts/sql/2025/20251210_update_user_now_playing_gamedb.sql

-- BEGIN scripts/sql/2025/20251211_thread_game_links.sql
-- Support multiple GameDB links per thread.
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'THREAD_GAME_LINKS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE THREAD_GAME_LINKS (
        THREAD_ID      VARCHAR2(50) NOT NULL,
        GAMEDB_GAME_ID NUMBER(10)   NOT NULL,
        LINKED_AT      TIMESTAMP    DEFAULT SYSTIMESTAMP NOT NULL,
        CONSTRAINT PK_THREAD_GAME_LINKS PRIMARY KEY (THREAD_ID, GAMEDB_GAME_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_THREAD_GAME_LINKS_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_THREAD_GAME_LINKS_GAME ON THREAD_GAME_LINKS (GAMEDB_GAME_ID)';
  END IF;
END;
/

COMMENT ON TABLE THREAD_GAME_LINKS IS 'Associates threads to one or more GameDB games.';
COMMENT ON COLUMN THREAD_GAME_LINKS.THREAD_ID IS 'Discord thread id';
COMMENT ON COLUMN THREAD_GAME_LINKS.GAMEDB_GAME_ID IS 'GameDB game id';
COMMENT ON COLUMN THREAD_GAME_LINKS.LINKED_AT IS 'When this link was created';

-- Backfill from existing single-link column.
MERGE INTO THREAD_GAME_LINKS tgt
USING (
  SELECT THREAD_ID, GAMEDB_GAME_ID
  FROM THREADS
  WHERE GAMEDB_GAME_ID IS NOT NULL
) src
ON (tgt.THREAD_ID = src.THREAD_ID AND tgt.GAMEDB_GAME_ID = src.GAMEDB_GAME_ID)
WHEN NOT MATCHED THEN
  INSERT (THREAD_ID, GAMEDB_GAME_ID, LINKED_AT)
  VALUES (src.THREAD_ID, src.GAMEDB_GAME_ID, SYSTIMESTAMP);
-- END scripts/sql/2025/20251211_thread_game_links.sql

-- BEGIN scripts/sql/2025/20251211_user_game_completions.sql
-- Track user game completions (replays allowed).
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE USER_GAME_COMPLETIONS (
        COMPLETION_ID      NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
        USER_ID            VARCHAR2(50) NOT NULL,
        GAMEDB_GAME_ID     NUMBER(10)   NOT NULL,
        COMPLETION_TYPE    VARCHAR2(50) NOT NULL,
        COMPLETED_AT       DATE         DEFAULT TRUNC(SYSDATE),
        FINAL_PLAYTIME_HRS NUMBER(8,2),
        CREATED_AT         TIMESTAMP    DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS'
    AND CONSTRAINT_NAME = 'CK_USER_GAME_COMPLETIONS_TYPE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_GAME_COMPLETIONS ADD CONSTRAINT CK_USER_GAME_COMPLETIONS_TYPE CHECK (COMPLETION_TYPE IN (''Main Story'', ''Main Story + Side Content'', ''Completionist''))';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS'
    AND CONSTRAINT_NAME = 'FK_UGC_GAMEDB_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_GAME_COMPLETIONS ADD CONSTRAINT FK_UGC_GAMEDB_GAME FOREIGN KEY (GAMEDB_GAME_ID) REFERENCES GAMEDB_GAMES (GAME_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_UGC_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_UGC_USER ON USER_GAME_COMPLETIONS (USER_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_UGC_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_UGC_GAME ON USER_GAME_COMPLETIONS (GAMEDB_GAME_ID)';
  END IF;
END;
/
-- END scripts/sql/2025/20251211_user_game_completions.sql

-- BEGIN scripts/sql/2025/20251219_add_failure_count_to_reminders.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'USER_REMINDERS'
     AND COLUMN_NAME = 'FAILURE_COUNT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_REMINDERS ADD (FAILURE_COUNT NUMBER DEFAULT 0 NOT NULL, FAILED_AT TIMESTAMP WITH TIME ZONE NULL)';
  END IF;
END;
/
-- END scripts/sql/2025/20251219_add_failure_count_to_reminders.sql

-- BEGIN scripts/sql/2026/20260102_add_note_to_user_game_completions.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_count
    FROM USER_TAB_COLS
   WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS'
     AND COLUMN_NAME = 'NOTE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_GAME_COMPLETIONS ADD NOTE VARCHAR2(500)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2026/20260102_add_note_to_user_game_completions.sql

-- BEGIN scripts/sql/2026/20260102_add_note_to_user_now_playing.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_NOW_PLAYING'
    AND COLUMN_NAME = 'NOTE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD NOTE VARCHAR2(500)';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2026/20260102_add_note_to_user_now_playing.sql

-- BEGIN scripts/sql/2026/20260102_create_bot_todos.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_TODOS (
        TODO_ID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        TITLE          VARCHAR2(200) NOT NULL,
        DETAILS        VARCHAR2(2000),
        CREATED_BY     VARCHAR2(30),
        CREATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        COMPLETED_AT   TIMESTAMP WITH TIME ZONE,
        COMPLETED_BY   VARCHAR2(30),
        IS_COMPLETED   NUMBER(1,0) DEFAULT 0 NOT NULL
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_RPG_CLUB_TODOS_STATUS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_RPG_CLUB_TODOS_STATUS ON RPG_CLUB_TODOS (IS_COMPLETED, CREATED_AT)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_TODOS_UPD
BEFORE UPDATE ON RPG_CLUB_TODOS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

commit;
-- END scripts/sql/2026/20260102_create_bot_todos.sql

-- BEGIN scripts/sql/2026/20260102_create_completionator_imports.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_COMPLETIONATOR_IMPORTS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_COMPLETIONATOR_IMPORTS (
        IMPORT_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        USER_ID         VARCHAR2(30) NOT NULL,
        STATUS          VARCHAR2(20) NOT NULL,
        CURRENT_INDEX   NUMBER DEFAULT 0 NOT NULL,
        TOTAL_COUNT     NUMBER DEFAULT 0 NOT NULL,
        SOURCE_FILENAME VARCHAR2(255),
        CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_COMPLETIONATOR_IMPORT_ITEMS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_COMPLETIONATOR_IMPORT_ITEMS (
        ITEM_ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        IMPORT_ID          NUMBER NOT NULL,
        ROW_INDEX          NUMBER NOT NULL,
        GAME_TITLE         VARCHAR2(500) NOT NULL,
        PLATFORM_NAME      VARCHAR2(200),
        REGION_NAME        VARCHAR2(200),
        SOURCE_TYPE        VARCHAR2(100),
        TIME_TEXT          VARCHAR2(50),
        COMPLETED_AT       DATE,
        COMPLETION_TYPE    VARCHAR2(50),
        PLAYTIME_HRS       NUMBER,
        STATUS             VARCHAR2(20) NOT NULL,
        GAMEDB_GAME_ID     NUMBER,
        COMPLETION_ID      NUMBER,
        ERROR_TEXT         VARCHAR2(2000)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'RPG_CLUB_COMPLETIONATOR_IMPORT_ITEMS'
    AND CONSTRAINT_NAME = 'FK_COMPLETIONATOR_IMPORT_ITEMS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_COMPLETIONATOR_IMPORT_ITEMS ADD CONSTRAINT FK_COMPLETIONATOR_IMPORT_ITEMS FOREIGN KEY (IMPORT_ID) REFERENCES RPG_CLUB_COMPLETIONATOR_IMPORTS (IMPORT_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_COMPLETIONATOR_IMPORTS_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_COMPLETIONATOR_IMPORTS_USER ON RPG_CLUB_COMPLETIONATOR_IMPORTS (USER_ID, STATUS)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_COMPLETIONATOR_ITEMS_IMPORT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_COMPLETIONATOR_ITEMS_IMPORT ON RPG_CLUB_COMPLETIONATOR_IMPORT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_COMPLETIONATOR_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_COMPLETIONATOR_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
-- END scripts/sql/2026/20260102_create_completionator_imports.sql

-- BEGIN scripts/sql/2026/20260102_create_suggestions.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_SUGGESTIONS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_SUGGESTIONS (
        SUGGESTION_ID  NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        TITLE          VARCHAR2(200) NOT NULL,
        DETAILS        VARCHAR2(2000),
        CREATED_BY     VARCHAR2(30),
        CREATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_RPG_CLUB_SUGGESTIONS_CREATED';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_RPG_CLUB_SUGGESTIONS_CREATED ON RPG_CLUB_SUGGESTIONS (CREATED_AT)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_SUGGESTIONS_UPD
BEFORE UPDATE ON RPG_CLUB_SUGGESTIONS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

commit;
-- END scripts/sql/2026/20260102_create_suggestions.sql

-- BEGIN scripts/sql/2026/20260106_add_todo_category.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND COLUMN_NAME = 'CATEGORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD CATEGORY VARCHAR2(20) DEFAULT ''Improvements'' NOT NULL';
  END IF;

  UPDATE RPG_CLUB_TODOS
  SET CATEGORY = 'Improvements'
  WHERE CATEGORY IS NULL;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND CONSTRAINT_NAME = 'CK_RPG_CLUB_TODOS_CATEGORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD CONSTRAINT CK_RPG_CLUB_TODOS_CATEGORY CHECK (CATEGORY IN (''New Features'', ''Improvements'', ''Defects''))';
  END IF;
END;
/
-- END scripts/sql/2026/20260106_add_todo_category.sql

-- BEGIN scripts/sql/2026/20260106_add_todo_category_column.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND COLUMN_NAME = 'TODO_CATEGORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD (TODO_CATEGORY VARCHAR2(20) DEFAULT ''Improvements'' NOT NULL, CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY CHECK (TODO_CATEGORY IN (''New Features'', ''Improvements'', ''Defects'')))';
  END IF;
END;
/
-- END scripts/sql/2026/20260106_add_todo_category_column.sql

-- BEGIN scripts/sql/2026/20260106_add_todo_category_field.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND COLUMN_NAME = 'TODO_CATEGORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD TODO_CATEGORY VARCHAR2(20) DEFAULT ''Improvements'' NOT NULL';
  END IF;

  UPDATE RPG_CLUB_TODOS
  SET TODO_CATEGORY = 'Improvements'
  WHERE TODO_CATEGORY IS NULL;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND CONSTRAINT_NAME = 'CK_RPG_CLUB_TODOS_TODO_CATEGORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY CHECK (TODO_CATEGORY IN (''New Features'', ''Improvements'', ''Defects''))';
  END IF;
END;
/
-- END scripts/sql/2026/20260106_add_todo_category_field.sql

-- BEGIN scripts/sql/2026/20260107_add_gamedb_alternate_versions.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_GAME_ALTERNATES';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_ALTERNATES (
        GAME_ID NUMBER NOT NULL,
        ALT_GAME_ID NUMBER NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        CREATED_BY VARCHAR2(64),
        CONSTRAINT PK_GAMEDB_GAME_ALTERNATES PRIMARY KEY (GAME_ID, ALT_GAME_ID),
        CONSTRAINT CK_GAMEDB_GAME_ALTS_ORDER CHECK (GAME_ID < ALT_GAME_ID),
        CONSTRAINT FK_GAMEDB_GAME_ALTS_GAME FOREIGN KEY (GAME_ID)
          REFERENCES GAMEDB_GAMES (GAME_ID),
        CONSTRAINT FK_GAMEDB_GAME_ALTS_ALT FOREIGN KEY (ALT_GAME_ID)
          REFERENCES GAMEDB_GAMES (GAME_ID)
      )';
  END IF;
END;
/
-- END scripts/sql/2026/20260107_add_gamedb_alternate_versions.sql

-- BEGIN scripts/sql/2026/20260201_add_gamedb_game_platforms.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_GAME_PLATFORMS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_GAME_PLATFORMS (
        GAME_ID NUMBER NOT NULL,
        PLATFORM_ID NUMBER NOT NULL,
        CONSTRAINT PK_GAMEDB_GAME_PLATFORMS PRIMARY KEY (GAME_ID, PLATFORM_ID),
        CONSTRAINT FK_GGP_GAME FOREIGN KEY (GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID) ON DELETE CASCADE,
        CONSTRAINT FK_GGP_PLATFORM FOREIGN KEY (PLATFORM_ID) REFERENCES GAMEDB_PLATFORMS(PLATFORM_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IDX_GGP_GAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GGP_GAME ON GAMEDB_GAME_PLATFORMS(GAME_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IDX_GGP_PLATFORM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GGP_PLATFORM ON GAMEDB_GAME_PLATFORMS(PLATFORM_ID)';
  END IF;
END;
/
-- END scripts/sql/2026/20260201_add_gamedb_game_platforms.sql

-- BEGIN scripts/sql/2026/20260201_add_platform_metadata_fields.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_PLATFORMS'
    AND COLUMN_NAME = 'PLATFORM_ABBREVIATION';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_PLATFORMS ADD PLATFORM_ABBREVIATION VARCHAR2(50)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_PLATFORMS'
    AND COLUMN_NAME = 'PLATFORM_SLUG';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_PLATFORMS ADD PLATFORM_SLUG VARCHAR2(255)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_PLATFORMS'
    AND COLUMN_NAME = 'PLATFORM_CHECKSUM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_PLATFORMS ADD PLATFORM_CHECKSUM VARCHAR2(64)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_PLATFORMS'
    AND COLUMN_NAME = 'IGDB_UPDATED_AT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_PLATFORMS ADD IGDB_UPDATED_AT NUMBER';
  END IF;
END;
/
-- END scripts/sql/2026/20260201_add_platform_metadata_fields.sql

-- BEGIN scripts/sql/2026/20260202_add_todo_size.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND COLUMN_NAME = 'TODO_SIZE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD TODO_SIZE VARCHAR2(4)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'RPG_CLUB_TODOS'
    AND CONSTRAINT_NAME = 'CK_RPG_CLUB_TODOS_SIZE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS ADD CONSTRAINT CK_RPG_CLUB_TODOS_SIZE CHECK (TODO_SIZE IN (''XS'',''S'',''M'',''L'',''XL'') OR TODO_SIZE IS NULL)';
  END IF;
END;
/
-- END scripts/sql/2026/20260202_add_todo_size.sql

-- BEGIN scripts/sql/2026/20260203_add_todo_blocked_category.sql
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS DROP CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -2443 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS DROP CONSTRAINT CK_RPG_CLUB_TODOS_CATEGORY';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -2443 THEN RAISE; END IF;
END;
/

ALTER TABLE RPG_CLUB_TODOS
  ADD CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY
  CHECK (TODO_CATEGORY IN ('New Features', 'Improvements', 'Defects', 'Blocked'));
-- END scripts/sql/2026/20260203_add_todo_blocked_category.sql

-- BEGIN scripts/sql/2026/20260203_add_todo_refactoring_category.sql
BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS DROP CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -2443 THEN RAISE; END IF;
END;
/

BEGIN
  EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_TODOS DROP CONSTRAINT CK_RPG_CLUB_TODOS_CATEGORY';
EXCEPTION
  WHEN OTHERS THEN
    IF SQLCODE != -2443 THEN RAISE; END IF;
END;
/

ALTER TABLE RPG_CLUB_TODOS
  ADD CONSTRAINT CK_RPG_CLUB_TODOS_TODO_CATEGORY
  CHECK (TODO_CATEGORY IN ('New Features', 'Improvements', 'Defects', 'Blocked', 'Refactoring'));
-- END scripts/sql/2026/20260203_add_todo_refactoring_category.sql

-- BEGIN scripts/sql/2026/20260113_create_game_key_giveaway.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_GAME_KEYS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_GAME_KEYS (
        KEY_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
        GAME_TITLE          VARCHAR2(200) NOT NULL,
        PLATFORM            VARCHAR2(50) NOT NULL,
        KEY_VALUE           VARCHAR2(200) NOT NULL,
        DONOR_USER_ID       VARCHAR2(30) NOT NULL,
        CLAIMED_BY_USER_ID  VARCHAR2(30),
        CLAIMED_AT          TIMESTAMP WITH TIME ZONE,
        CREATED_AT          TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        UPDATED_AT          TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_GAME_KEYS_TITLE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_GAME_KEYS_TITLE ON RPG_CLUB_GAME_KEYS (GAME_TITLE)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_GAME_KEYS_AVAILABLE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_GAME_KEYS_AVAILABLE ON RPG_CLUB_GAME_KEYS (CLAIMED_BY_USER_ID, GAME_TITLE)';
  END IF;
END;
/

CREATE OR REPLACE TRIGGER TRG_RPG_CLUB_GAME_KEYS_UPD
BEFORE UPDATE ON RPG_CLUB_GAME_KEYS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

commit;
-- END scripts/sql/2026/20260113_create_game_key_giveaway.sql

-- BEGIN scripts/sql/2026/20260114_add_user_now_playing_sort_order.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_NOW_PLAYING'
    AND COLUMN_NAME = 'SORT_ORDER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD SORT_ORDER NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IX_USER_NOW_PLAYING_SORT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IX_USER_NOW_PLAYING_SORT ON USER_NOW_PLAYING (USER_ID, SORT_ORDER)';
  END IF;
END;
/

commit;
-- END scripts/sql/2026/20260114_add_user_now_playing_sort_order.sql

-- BEGIN scripts/sql/2026/20260114_add_donor_notify_to_users.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_USERS'
    AND COLUMN_NAME = 'DONOR_NOTIFY_ON_CLAIM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_USERS ADD (DONOR_NOTIFY_ON_CLAIM NUMBER(1) DEFAULT 0 NOT NULL)';
  END IF;
END;
/

COMMENT ON COLUMN RPG_CLUB_USERS.DONOR_NOTIFY_ON_CLAIM IS
  '1 when the user wants to be notified when a donated key is claimed.';

DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_USERS_HIST'
    AND COLUMN_NAME = 'DONOR_NOTIFY_ON_CLAIM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_USERS_HIST ADD (DONOR_NOTIFY_ON_CLAIM NUMBER(1))';
  END IF;
END;
/

COMMENT ON COLUMN RPG_CLUB_USERS_HIST.DONOR_NOTIFY_ON_CLAIM IS
  'Audit snapshot of donor notification preference.';
-- END scripts/sql/2026/20260114_add_donor_notify_to_users.sql

-- BEGIN scripts/sql/2026/20260114_add_game_key_notify_on_claim.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_GAME_KEYS'
    AND COLUMN_NAME = 'DONOR_NOTIFY_ON_CLAIM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_GAME_KEYS ADD (DONOR_NOTIFY_ON_CLAIM NUMBER(1) DEFAULT 0 NOT NULL)';
  END IF;
END;
/

COMMENT ON COLUMN RPG_CLUB_GAME_KEYS.DONOR_NOTIFY_ON_CLAIM IS
  '1 when the donor requests a notification on claim.';
-- END scripts/sql/2026/20260114_add_game_key_notify_on_claim.sql

-- BEGIN scripts/sql/2026/20260116_add_presence_prompt_optouts.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_PRESENCE_PROMPT_OPTS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_PRESENCE_PROMPT_OPTS (
        USER_ID VARCHAR2(30) NOT NULL,
        SCOPE VARCHAR2(10) NOT NULL,
        GAME_TITLE VARCHAR2(300),
        GAME_TITLE_NORM VARCHAR2(300) NOT NULL,
        CREATED_AT TIMESTAMP(6) WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        CONSTRAINT PK_RPG_CLUB_PRESENCE_PROMPT_OPTS PRIMARY KEY (USER_ID, SCOPE, GAME_TITLE_NORM),
        CONSTRAINT CK_RPG_CLUB_PRESENCE_PROMPT_SCOPE CHECK (SCOPE IN (''ALL'', ''GAME''))
      )';
  END IF;
END;
/
-- END scripts/sql/2026/20260116_add_presence_prompt_optouts.sql

-- BEGIN scripts/sql/2026/20260116_create_starboard_table.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_STARBOARD';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_STARBOARD (
        MESSAGE_ID VARCHAR2(30) NOT NULL,
        CHANNEL_ID VARCHAR2(30) NOT NULL,
        STARBOARD_MESSAGE_ID VARCHAR2(30) NOT NULL,
        AUTHOR_ID VARCHAR2(30) NOT NULL,
        STAR_COUNT NUMBER(5,0) DEFAULT 0 NOT NULL,
        CREATED_AT TIMESTAMP(6) WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        CONSTRAINT PK_RPG_CLUB_STARBOARD PRIMARY KEY (MESSAGE_ID)
      )';
  END IF;
END;
/
-- END scripts/sql/2026/20260116_create_starboard_table.sql

-- BEGIN scripts/sql/2026/20260116_create_presence_prompt_history.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_PRESENCE_PROMPT_HISTORY';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_PRESENCE_PROMPT_HISTORY (
        PROMPT_ID VARCHAR2(64) NOT NULL,
        USER_ID VARCHAR2(30) NOT NULL,
        GAME_TITLE VARCHAR2(300) NOT NULL,
        GAME_TITLE_NORM VARCHAR2(300) NOT NULL,
        STATUS VARCHAR2(20) DEFAULT ''PENDING'' NOT NULL,
        CREATED_AT TIMESTAMP(6) WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
        RESOLVED_AT TIMESTAMP(6) WITH TIME ZONE,
        CONSTRAINT PK_RPG_CLUB_PRESENCE_PROMPT_HISTORY PRIMARY KEY (PROMPT_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IDX_RPG_CLUB_PRESENCE_PROMPT_HIST_USER';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_RPG_CLUB_PRESENCE_PROMPT_HIST_USER ON RPG_CLUB_PRESENCE_PROMPT_HISTORY (USER_ID, GAME_TITLE_NORM, STATUS)';
  END IF;
END;
/
-- END scripts/sql/2026/20260116_create_presence_prompt_history.sql

-- BEGIN scripts/sql/2026/20260118_add_gamedb_featured_video.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND COLUMN_NAME = 'FEATURED_VIDEO_URL';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD FEATURED_VIDEO_URL VARCHAR2(512)';
  END IF;
END;
/
-- END scripts/sql/2026/20260118_add_gamedb_featured_video.sql

-- BEGIN scripts/sql/2026/20260128_add_note_updated_at_user_now_playing.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_NOW_PLAYING'
    AND COLUMN_NAME = 'NOTE_UPDATED_AT';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_NOW_PLAYING ADD NOTE_UPDATED_AT TIMESTAMP WITH TIME ZONE';
  END IF;
END;
/

COMMIT;
-- END scripts/sql/2026/20260128_add_note_updated_at_user_now_playing.sql

-- BEGIN scripts/sql/2026/20260129_add_gamedb_initial_release_date.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'GAMEDB_GAMES'
    AND COLUMN_NAME = 'INITIAL_RELEASE_DATE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES ADD INITIAL_RELEASE_DATE DATE';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_RELEASES';
  IF v_count > 0 THEN
    EXECUTE IMMEDIATE q'[
      UPDATE GAMEDB_GAMES g
      SET INITIAL_RELEASE_DATE = (
        SELECT MIN(r.RELEASE_DATE)
        FROM GAMEDB_RELEASES r
        WHERE r.GAME_ID = g.GAME_ID
          AND r.RELEASE_DATE IS NOT NULL
      )
      WHERE EXISTS (
        SELECT 1
        FROM GAMEDB_RELEASES r
        WHERE r.GAME_ID = g.GAME_ID
          AND r.RELEASE_DATE IS NOT NULL
      )
    ]';
  END IF;
END;
/
-- END scripts/sql/2026/20260129_add_gamedb_initial_release_date.sql

-- BEGIN scripts/sql/2026/20260129_add_suggestion_github_fields.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_SUGGESTIONS'
    AND COLUMN_NAME = 'LABELS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_SUGGESTIONS ADD LABELS VARCHAR2(200)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'RPG_CLUB_SUGGESTIONS'
    AND COLUMN_NAME = 'CREATED_BY_NAME';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE RPG_CLUB_SUGGESTIONS ADD CREATED_BY_NAME VARCHAR2(100)';
  END IF;
END;
/

commit;
-- END scripts/sql/2026/20260129_add_suggestion_github_fields.sql

-- BEGIN scripts/sql/2026/20260129_drop_gamedb_games_title_unique.sql
DECLARE
  v_constraint_name user_constraints.constraint_name%TYPE;
BEGIN
  SELECT uc.constraint_name
    INTO v_constraint_name
    FROM user_constraints uc
    JOIN user_cons_columns ucc
      ON uc.constraint_name = ucc.constraint_name
     AND uc.table_name = ucc.table_name
   WHERE uc.table_name = 'GAMEDB_GAMES'
     AND uc.constraint_type = 'U'
     AND ucc.column_name = 'TITLE'
     AND ucc.position = 1;

  EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_GAMES DROP CONSTRAINT ' || v_constraint_name;
EXCEPTION
  WHEN NO_DATA_FOUND THEN
    NULL;
END;
/
-- END scripts/sql/2026/20260129_drop_gamedb_games_title_unique.sql

-- BEGIN scripts/sql/2026/20260129_add_hltb_cache.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'RPG_CLUB_HLTB_CACHE';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE RPG_CLUB_HLTB_CACHE (
        CACHE_ID        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        GAMEDB_GAME_ID  NUMBER NOT NULL,
        HLTB_NAME       VARCHAR2(255),
        HLTB_URL        VARCHAR2(512),
        HLTB_IMAGE_URL  VARCHAR2(512),
        MAIN            VARCHAR2(50),
        MAIN_SIDES      VARCHAR2(50),
        COMPLETIONIST   VARCHAR2(50),
        SINGLE_PLAYER   VARCHAR2(50),
        CO_OP           VARCHAR2(50),
        VS              VARCHAR2(50),
        SOURCE_QUERY    VARCHAR2(255),
        SCRAPED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UPDATED_AT      TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        CONSTRAINT FK_HLTB_GAME FOREIGN KEY (GAMEDB_GAME_ID) REFERENCES GAMEDB_GAMES(GAME_ID)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'UQ_HLTB_GAME_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE UNIQUE INDEX UQ_HLTB_GAME_ID ON RPG_CLUB_HLTB_CACHE (GAMEDB_GAME_ID)';
  END IF;
END;
/
-- END scripts/sql/2026/20260129_add_hltb_cache.sql

-- BEGIN scripts/sql/2026/20260129_add_completion_platform.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TAB_COLS
  WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS'
    AND COLUMN_NAME = 'PLATFORM_ID';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_GAME_COMPLETIONS ADD PLATFORM_ID NUMBER';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_CONSTRAINTS
  WHERE TABLE_NAME = 'USER_GAME_COMPLETIONS'
    AND CONSTRAINT_NAME = 'FK_USER_GAME_COMPLETIONS_PLATFORM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE USER_GAME_COMPLETIONS ADD CONSTRAINT FK_USER_GAME_COMPLETIONS_PLATFORM FOREIGN KEY (PLATFORM_ID) REFERENCES GAMEDB_PLATFORMS (PLATFORM_ID)';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IDX_USER_GAME_COMPLETIONS_PLATFORM';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_USER_GAME_COMPLETIONS_PLATFORM ON USER_GAME_COMPLETIONS (PLATFORM_ID)';
  END IF;
END;
/
-- END scripts/sql/2026/20260129_add_completion_platform.sql

-- BEGIN scripts/sql/2026/20260130_add_gamedb_search_synonyms.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_SEARCH_SYNONYM_GROUPS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_SEARCH_SYNONYM_GROUPS (
        GROUP_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        CREATED_BY VARCHAR2(64)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_SEARCH_SYNONYMS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_SEARCH_SYNONYMS (
        TERM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        GROUP_ID NUMBER NOT NULL,
        TERM_TEXT VARCHAR2(255) NOT NULL,
        TERM_NORM VARCHAR2(255) NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        CREATED_BY VARCHAR2(64),
        CONSTRAINT FK_GAMEDB_SEARCH_SYNONYMS_GROUP
          FOREIGN KEY (GROUP_ID)
          REFERENCES GAMEDB_SEARCH_SYNONYM_GROUPS (GROUP_ID),
        CONSTRAINT UK_GAMEDB_SEARCH_SYNONYMS_NORM
          UNIQUE (TERM_NORM)
      )';
  END IF;

  SELECT COUNT(*) INTO v_count
  FROM USER_INDEXES
  WHERE INDEX_NAME = 'IDX_GAMEDB_SEARCH_SYNONYMS_GROUP';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE 'CREATE INDEX IDX_GAMEDB_SEARCH_SYNONYMS_GROUP ON GAMEDB_SEARCH_SYNONYMS (GROUP_ID)';
  END IF;
END;
/
-- END scripts/sql/2026/20260130_add_gamedb_search_synonyms.sql

-- BEGIN scripts/sql/2026/20260130_add_gamedb_search_synonyms_if_missing.sql
DECLARE
  v_table_count NUMBER := 0;
  v_index_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_table_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GAMEDB_SEARCH_SYNONYM_GROUPS';
  IF v_table_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_SEARCH_SYNONYM_GROUPS (
        GROUP_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        CREATED_BY VARCHAR2(64)
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_table_count
    FROM USER_TABLES
   WHERE TABLE_NAME = 'GAMEDB_SEARCH_SYNONYMS';
  IF v_table_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_SEARCH_SYNONYMS (
        TERM_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        GROUP_ID NUMBER NOT NULL,
        TERM_TEXT VARCHAR2(255) NOT NULL,
        TERM_NORM VARCHAR2(255) NOT NULL,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        CREATED_BY VARCHAR2(64),
        CONSTRAINT FK_GAMEDB_SEARCH_SYNONYMS_GROUP
          FOREIGN KEY (GROUP_ID)
          REFERENCES GAMEDB_SEARCH_SYNONYM_GROUPS (GROUP_ID),
        CONSTRAINT UK_GAMEDB_SEARCH_SYNONYMS_NORM
          UNIQUE (TERM_NORM)
      )';
  END IF;

  SELECT COUNT(*)
    INTO v_index_count
    FROM USER_INDEXES
   WHERE INDEX_NAME = 'IDX_GAMEDB_SEARCH_SYNONYMS_GROUP';
  IF v_index_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE INDEX IDX_GAMEDB_SEARCH_SYNONYMS_GROUP
        ON GAMEDB_SEARCH_SYNONYMS (GROUP_ID)';
  END IF;
END;
/
-- END scripts/sql/2026/20260130_add_gamedb_search_synonyms_if_missing.sql

-- BEGIN scripts/sql/2026/20260130_add_gamedb_search_synonym_drafts.sql
DECLARE
  v_count NUMBER := 0;
BEGIN
  SELECT COUNT(*) INTO v_count
  FROM USER_TABLES
  WHERE TABLE_NAME = 'GAMEDB_SEARCH_SYNONYM_DRAFTS';
  IF v_count = 0 THEN
    EXECUTE IMMEDIATE '
      CREATE TABLE GAMEDB_SEARCH_SYNONYM_DRAFTS (
        DRAFT_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
        USER_ID VARCHAR2(64) NOT NULL,
        PAIRS_JSON CLOB,
        CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
        UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
      )';
  END IF;
END;
/
-- END scripts/sql/2026/20260130_add_gamedb_search_synonym_drafts.sql

-- BEGIN scripts/sql/2026/20260130_update_gamedb_search_synonyms_multigroup.sql
DECLARE
  v_constraint_count NUMBER := 0;
BEGIN
  SELECT COUNT(*)
    INTO v_constraint_count
    FROM USER_CONSTRAINTS
   WHERE CONSTRAINT_NAME = 'UK_GAMEDB_SEARCH_SYNONYMS_NORM'
     AND TABLE_NAME = 'GAMEDB_SEARCH_SYNONYMS';
  IF v_constraint_count > 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_SEARCH_SYNONYMS DROP CONSTRAINT UK_GAMEDB_SEARCH_SYNONYMS_NORM';
  END IF;

  SELECT COUNT(*)
    INTO v_constraint_count
    FROM USER_CONSTRAINTS
   WHERE CONSTRAINT_NAME = 'UK_GAMEDB_SEARCH_SYNONYMS_GROUP_NORM'
     AND TABLE_NAME = 'GAMEDB_SEARCH_SYNONYMS';
  IF v_constraint_count = 0 THEN
    EXECUTE IMMEDIATE 'ALTER TABLE GAMEDB_SEARCH_SYNONYMS
      ADD CONSTRAINT UK_GAMEDB_SEARCH_SYNONYMS_GROUP_NORM UNIQUE (GROUP_ID, TERM_NORM)';
  END IF;
END;
/
-- END scripts/sql/2026/20260130_update_gamedb_search_synonyms_multigroup.sql

-- BEGIN scripts/sql/2026/20260130_seed_gamedb_search_synonyms.sql
DECLARE
  v_seeded NUMBER := 0;

  PROCEDURE ensure_group(p_terms SYS.ODCIVARCHAR2LIST) IS
    v_group_id NUMBER;
    v_exists NUMBER;
  BEGIN
    INSERT INTO GAMEDB_SEARCH_SYNONYM_GROUPS (CREATED_BY)
    VALUES ('seed')
    RETURNING GROUP_ID INTO v_group_id;

    FOR i IN 1 .. p_terms.COUNT LOOP
      SELECT COUNT(*)
        INTO v_exists
        FROM GAMEDB_SEARCH_SYNONYMS
       WHERE GROUP_ID = v_group_id
         AND TERM_NORM = REGEXP_REPLACE(LOWER(p_terms(i)), '[^a-z0-9]', '');
      IF v_exists = 0 THEN
        INSERT INTO GAMEDB_SEARCH_SYNONYMS (GROUP_ID, TERM_TEXT, TERM_NORM, CREATED_BY)
        VALUES (
          v_group_id,
          p_terms(i),
          REGEXP_REPLACE(LOWER(p_terms(i)), '[^a-z0-9]', ''),
          'seed'
        );
      END IF;
    END LOOP;
  END;

  FUNCTION number_to_word(p_num NUMBER) RETURN VARCHAR2 IS
  BEGIN
    RETURN CASE p_num
      WHEN 1 THEN 'one'
      WHEN 2 THEN 'two'
      WHEN 3 THEN 'three'
      WHEN 4 THEN 'four'
      WHEN 5 THEN 'five'
      WHEN 6 THEN 'six'
      WHEN 7 THEN 'seven'
      WHEN 8 THEN 'eight'
      WHEN 9 THEN 'nine'
      WHEN 10 THEN 'ten'
      WHEN 11 THEN 'eleven'
      WHEN 12 THEN 'twelve'
      WHEN 13 THEN 'thirteen'
      WHEN 14 THEN 'fourteen'
      WHEN 15 THEN 'fifteen'
      WHEN 16 THEN 'sixteen'
      WHEN 17 THEN 'seventeen'
      WHEN 18 THEN 'eighteen'
      WHEN 19 THEN 'nineteen'
      WHEN 20 THEN 'twenty'
      ELSE NULL
    END;
  END;

  FUNCTION to_roman(p_num NUMBER) RETURN VARCHAR2 IS
    v_num NUMBER := p_num;
    v_result VARCHAR2(100) := '';
    TYPE t_num_tab IS TABLE OF NUMBER;
    TYPE t_str_tab IS TABLE OF VARCHAR2(10);
    v_nums t_num_tab := t_num_tab(100, 90, 50, 40, 10, 9, 5, 4, 1);
    v_strs t_str_tab := t_str_tab('C', 'XC', 'L', 'XL', 'X', 'IX', 'V', 'IV', 'I');
  BEGIN
    IF v_num < 1 OR v_num > 100 THEN
      RETURN NULL;
    END IF;
    FOR i IN 1 .. v_nums.COUNT LOOP
      WHILE v_num >= v_nums(i) LOOP
        v_result := v_result || v_strs(i);
        v_num := v_num - v_nums(i);
      END LOOP;
    END LOOP;
    RETURN v_result;
  END;
BEGIN
  SELECT COUNT(*)
    INTO v_seeded
    FROM GAMEDB_SEARCH_SYNONYMS
   WHERE CREATED_BY = 'seed';

  IF v_seeded = 0 THEN
    FOR i IN 1 .. 100 LOOP
      IF i <= 20 THEN
        ensure_group(
          SYS.ODCIVARCHAR2LIST(
            TO_CHAR(i),
            to_roman(i),
            number_to_word(i)
          )
        );
      ELSE
        ensure_group(
          SYS.ODCIVARCHAR2LIST(
            TO_CHAR(i),
            to_roman(i)
          )
        );
      END IF;
    END LOOP;

    ensure_group(SYS.ODCIVARCHAR2LIST('FF', 'Final Fantasy'));
    ensure_group(SYS.ODCIVARCHAR2LIST('GTA', 'Grand Theft Auto'));
    ensure_group(SYS.ODCIVARCHAR2LIST('DQ', 'Dragon Quest'));
    ensure_group(SYS.ODCIVARCHAR2LIST('AC', 'Animal Crossing'));
    ensure_group(SYS.ODCIVARCHAR2LIST('AC', 'Asheron''s Call'));
    ensure_group(SYS.ODCIVARCHAR2LIST('AC', 'Assassin''s Creed'));
  END IF;
END;
/
-- END scripts/sql/2026/20260130_seed_gamedb_search_synonyms.sql

exit
