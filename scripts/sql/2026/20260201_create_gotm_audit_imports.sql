CREATE TABLE RPG_CLUB_GOTM_AUDIT_IMPORTS (
  IMPORT_ID       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID         VARCHAR2(30) NOT NULL,
  STATUS          VARCHAR2(20) NOT NULL,
  CURRENT_INDEX   NUMBER DEFAULT 0 NOT NULL,
  TOTAL_COUNT     NUMBER DEFAULT 0 NOT NULL,
  SOURCE_FILENAME VARCHAR2(255),
  CREATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT      TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

CREATE TABLE RPG_CLUB_GOTM_AUDIT_ITEMS (
  ITEM_ID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  IMPORT_ID      NUMBER NOT NULL,
  ROW_INDEX      NUMBER NOT NULL,
  KIND           VARCHAR2(10) NOT NULL,
  ROUND_NUMBER   NUMBER NOT NULL,
  MONTH_YEAR     VARCHAR2(50) NOT NULL,
  GAME_INDEX     NUMBER NOT NULL,
  GAME_TITLE     VARCHAR2(500) NOT NULL,
  THREAD_ID      VARCHAR2(30),
  REDDIT_URL     VARCHAR2(1000),
  STATUS         VARCHAR2(20) NOT NULL,
  GAMEDB_GAME_ID NUMBER,
  ERROR_TEXT     VARCHAR2(2000)
);

ALTER TABLE RPG_CLUB_GOTM_AUDIT_ITEMS
  ADD CONSTRAINT FK_GOTM_AUDIT_ITEMS
  FOREIGN KEY (IMPORT_ID)
  REFERENCES RPG_CLUB_GOTM_AUDIT_IMPORTS (IMPORT_ID);

CREATE INDEX IX_GOTM_AUDIT_IMPORTS_USER
  ON RPG_CLUB_GOTM_AUDIT_IMPORTS (USER_ID, STATUS);

CREATE INDEX IX_GOTM_AUDIT_ITEMS_IMPORT
  ON RPG_CLUB_GOTM_AUDIT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX);

CREATE INDEX IX_GOTM_AUDIT_ITEMS_ROUND
  ON RPG_CLUB_GOTM_AUDIT_ITEMS (IMPORT_ID, KIND, ROUND_NUMBER);

CREATE OR REPLACE TRIGGER TRG_GOTM_AUDIT_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_GOTM_AUDIT_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
