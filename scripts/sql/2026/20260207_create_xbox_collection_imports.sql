CREATE TABLE RPG_CLUB_XBOX_COLLECTION_IMPORTS (
  IMPORT_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  USER_ID           VARCHAR2(30) NOT NULL,
  STATUS            VARCHAR2(20) NOT NULL,
  CURRENT_INDEX     NUMBER DEFAULT 0 NOT NULL,
  TOTAL_COUNT       NUMBER DEFAULT 0 NOT NULL,
  XUID              VARCHAR2(30),
  GAMERTAG          VARCHAR2(100),
  SOURCE_TYPE       VARCHAR2(20) NOT NULL,
  SOURCE_FILE_NAME  VARCHAR2(255),
  SOURCE_FILE_SIZE  NUMBER,
  TEMPLATE_VERSION  VARCHAR2(20),
  CREATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT        TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE RPG_CLUB_XBOX_COLLECTION_IMPORTS
  ADD CONSTRAINT CK_XBOX_COLL_IMPORTS_STATUS
  CHECK (STATUS IN ('ACTIVE', 'PAUSED', 'COMPLETED', 'CANCELED'));

ALTER TABLE RPG_CLUB_XBOX_COLLECTION_IMPORTS
  ADD CONSTRAINT CK_XBOX_COLL_IMPORTS_SOURCE
  CHECK (SOURCE_TYPE IN ('API', 'CSV'));

CREATE TABLE RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS (
  ITEM_ID              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  IMPORT_ID            NUMBER NOT NULL,
  ROW_INDEX            NUMBER NOT NULL,
  XBOX_TITLE_ID        VARCHAR2(40),
  XBOX_PRODUCT_ID      VARCHAR2(80),
  XBOX_TITLE_NAME      VARCHAR2(500) NOT NULL,
  RAW_PLATFORM         VARCHAR2(200),
  RAW_OWNERSHIP_TYPE   VARCHAR2(60),
  RAW_NOTE             VARCHAR2(500),
  RAW_GAMEDB_ID        NUMBER,
  RAW_IGDB_ID          NUMBER,
  PLATFORM_ID          NUMBER,
  OWNERSHIP_TYPE       VARCHAR2(30),
  NOTE                 VARCHAR2(500),
  STATUS               VARCHAR2(20) NOT NULL,
  MATCH_CONFIDENCE     VARCHAR2(20),
  MATCH_CANDIDATE_JSON CLOB,
  GAMEDB_GAME_ID       NUMBER,
  COLLECTION_ENTRY_ID  NUMBER,
  RESULT_REASON        VARCHAR2(40),
  ERROR_TEXT           VARCHAR2(2000)
);

ALTER TABLE RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT FK_XBOX_COLL_IMPORT_ITEMS
  FOREIGN KEY (IMPORT_ID)
  REFERENCES RPG_CLUB_XBOX_COLLECTION_IMPORTS (IMPORT_ID);

ALTER TABLE RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT CK_XBOX_COLL_ITEMS_STATUS
  CHECK (STATUS IN ('PENDING', 'ADDED', 'UPDATED', 'SKIPPED', 'FAILED'));

ALTER TABLE RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS
  ADD CONSTRAINT CK_XBOX_COLL_ITEMS_REASON
  CHECK (
    RESULT_REASON IS NULL OR
    RESULT_REASON IN (
      'AUTO_MATCH',
      'XBOX_GAMEDB_ID',
      'XBOX_IGDB_ID',
      'MANUAL_REMAP',
      'DUPLICATE',
      'MANUAL_SKIP',
      'SKIP_MAPPED',
      'NO_CANDIDATE',
      'INVALID_REMAP',
      'PLATFORM_UNRESOLVED',
      'ADD_FAILED',
      'INVALID_ROW'
    )
  );

CREATE TABLE RPG_CLUB_XBOX_TITLE_GAMEDB_MAP (
  MAP_ID         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
  XBOX_TITLE_ID  VARCHAR2(40) NOT NULL,
  GAMEDB_GAME_ID NUMBER,
  STATUS         VARCHAR2(20) NOT NULL,
  CREATED_BY     VARCHAR2(30),
  CREATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL,
  UPDATED_AT     TIMESTAMP WITH TIME ZONE DEFAULT SYSTIMESTAMP NOT NULL
);

ALTER TABLE RPG_CLUB_XBOX_TITLE_GAMEDB_MAP
  ADD CONSTRAINT UX_XBOX_TITLE_GAMEDB_MAP_TITLE
  UNIQUE (XBOX_TITLE_ID);

ALTER TABLE RPG_CLUB_XBOX_TITLE_GAMEDB_MAP
  ADD CONSTRAINT CK_XBOX_TITLE_GAMEDB_MAP_STATUS
  CHECK (STATUS IN ('MAPPED', 'SKIPPED'));

CREATE INDEX IX_XBOX_COLL_IMPORTS_USER
  ON RPG_CLUB_XBOX_COLLECTION_IMPORTS (USER_ID, STATUS);
CREATE INDEX IX_XBOX_COLL_ITEMS_IMPORT
  ON RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS (IMPORT_ID, STATUS, ROW_INDEX);
CREATE INDEX IX_XBOX_COLL_ITEMS_TITLE
  ON RPG_CLUB_XBOX_COLLECTION_IMPORT_ITEMS (XBOX_TITLE_ID);
CREATE INDEX IX_XBOX_TITLE_GAMEDB_MAP_STATUS
  ON RPG_CLUB_XBOX_TITLE_GAMEDB_MAP (STATUS);

CREATE OR REPLACE TRIGGER TRG_XBOX_COLL_IMPORTS_UPD
BEFORE UPDATE ON RPG_CLUB_XBOX_COLLECTION_IMPORTS
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

CREATE OR REPLACE TRIGGER TRG_XBOX_TITLE_GAMEDB_MAP_UPD
BEFORE UPDATE ON RPG_CLUB_XBOX_TITLE_GAMEDB_MAP
FOR EACH ROW
BEGIN
  :NEW.UPDATED_AT := SYSTIMESTAMP;
END;
/

COMMIT;
